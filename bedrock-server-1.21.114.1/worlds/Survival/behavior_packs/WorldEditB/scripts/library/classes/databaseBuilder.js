import{Entity as d,world as s}from"@minecraft/server";import{contentLog as o,Server as p,whenReady as b}from"library/Minecraft.js";let g;b(()=>s.scoreboard.getObjective("GAMETEST_DB")??s.scoreboard.addObjective("GAMETEST_DB",""));const i={},m=[];function f(n,t){return JSON.parse(t,(e,a)=>{for(const r of m)a=r(e,a,n);return a})}function c(n,t){return n+"//"+(t instanceof d?t.id:"world")}class v{load(t,e=s,a=!1){const r=c(t,e);return i[r]||(i[r]=new l(t,e,a),i[r].load()),i[r]}delete(t,e=s){const a=c(t,e),r=i[a]??new l(t,e);r.isValid&&r.delete(),delete i[a]}find(t,e=s){return e.getDynamicPropertyIds().filter(a=>a.match(t))}getRawData(t,e=s){const a=c(t,e);return(i[a]??new l(t,e)).rawData}addParser(t){m.push(t)}}const y=new v;class l{constructor(t,e=s,a=!1){this.name=t;this.provider=e;this.legacyStorage=a;this._data={};this.loaded=!1;this.valid=!0}get data(){if(!this.valid)throw new Error(`Can't get data from invalid database "${this.name}".`);return this.loaded||this.load(),this._data}set data(t){if(!this.valid)throw new Error(`Can't set data on invalid database "${this.name}".`);this.loaded=!0,this._data=t}get rawData(){const t=this.getScoreboardParticipant();let e;if(t)e=JSON.parse(`"${t.displayName}"`).slice(`[\\"${this.getScoreboardName()}\\"`.length-1,-1);else{e=this.provider.getDynamicProperty(this.name);let a,r=2;for(;e&&(a=this.provider.getDynamicProperty(`__page${r++}__`+this.name));)e+=a}return e}get isLoaded(){return this.loaded}get isValid(){return this.valid}clear(){if(!this.valid)throw new Error(`Can't clear data from invalid database "${this.name}".`);this.loaded||this.load(),this._data={}}save(){if(!this.valid)throw new Error(`Can't save data to invalid database "${this.name}".`);const t=this.getScoreboardParticipant();if(this.legacyStorage){const a=this.getScoreboardName();t&&p.runCommand(`scoreboard players reset "${t.displayName}" GAMETEST_DB`),p.runCommand(`scoreboard players add ${JSON.stringify(JSON.stringify([a,this._data]))} GAMETEST_DB 0`);return}else t&&!this.legacyStorage&&g.removeParticipant(t);const e=JSON.stringify(this._data);t:for(let a=1;a<=50;a++){let r;const _=Math.ceil(e.length/a);for(let h=0;h<e.length;h+=_)try{this.provider.setDynamicProperty((r?`__page${r}__`:"")+this.name,e.slice(h,h+_)),r=(r??1)+1}catch{continue t}for(;this.provider.getDynamicProperty(`__page${r}__`+this.name);)this.provider.setDynamicProperty(`__page${r++}__`+this.name,void 0);this.loaded=!0;return}o.error(`Failed to save database ${this.name} to ${this.provider instanceof d?this.provider.nameTag??this.provider.id:"the world"}`),o.debug(o.stack())}load(){if(!this.valid)throw new Error(`Can't load data from invalid database "${this.name}".`);if(!this.loaded){try{this._data=f(this.name,this.rawData??"{}")}catch(t){o.error(`Failed to load database ${this.name} from ${this.provider instanceof d?this.provider.nameTag??this.provider.id:"the world"}`),t&&o.debug(t,t.stack);return}this.loaded=!0}}delete(){if(!this.valid)throw new Error(`Can't delete invalid database "${this.name}".`);const t=this.getScoreboardParticipant();if(t)g.removeParticipant(t);else{this.provider.setDynamicProperty(this.name,void 0);let e=2;for(;this.provider.getDynamicProperty(`__page${e}__`+this.name);)this.provider.setDynamicProperty(`__page${e++}__`+this.name,void 0)}this.valid=!1,y.delete(this.name,this.provider)}toJSON(){const t={__dbName__:this.name};return this.provider instanceof d&&(t.__dbProvider__=this.provider.id),this.legacyStorage&&(t.__dbLegacy__=!0),t}getScoreboardParticipant(){for(const t of g?.getParticipants()??[])if(t.displayName.startsWith(`[\\"${this.getScoreboardName()}\\"`))return t}getScoreboardName(){let t="wedit:"+this.name;return this.provider instanceof d&&(t+=this.provider.id),t}}y.addParser((n,t)=>{if(!t||typeof t!="object"||!t.__dbName__)return t;const e=t.__dbProvider__?s.getEntity(t.__dbProvider__):s,a=c(t.__dbName__,e);return i[a]||(i[a]=new l(t.__dbName__,e,t.__dbLegacy__)),i[a]});export{y as Databases};
