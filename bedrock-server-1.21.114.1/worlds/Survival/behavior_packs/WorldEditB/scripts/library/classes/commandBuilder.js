import{configuration as P}from"../configurations.js";import{Player as N}from"./playerBuilder.js";import{contentLog as R,RawText as y,Thread as L}from"../utils/index.js";import{EventEmitter as F}from"./eventEmitter.js";class tt{}class v{constructor(){this.x=0;this.y=0;this.z=0;this.xRelative=!0;this.yRelative=!0;this.zRelative=!0}clone(){const h=new v;return h.x=this.x,h.y=this.y,h.z=this.z,h.xRelative=this.xRelative,h.yRelative=this.yRelative,h.zRelative=this.zRelative,h}relativeTo(h,o=!1){const r={x:0,y:0,z:0},i=this.x+(this.xRelative?h.location.x:0),m=this.y+(this.yRelative?h.location.y:0),f=this.z+(this.zRelative?h.location.z:0);return r.x=o?Math.floor(i):i,r.y=o?Math.floor(m):m,r.z=o?Math.floor(f):f,r}static parseArgs(h,o,r=!0){const i=new v;for(let m=0;m<(r?3:2);m++){let f=h[o];if(!h)throw{isSyntaxError:!0,stack:R.stack(),idx:-1};let w=!1;f.includes("~")&&(f=f.slice(1),w=!0);const a=f==""?0:parseFloat(f);if(a!=a||isNaN(a))throw y.translate("commands.generic.num.invalid").with(f);m==0?(i.x=a,i.xRelative=w):m==1&&r?(i.y=a,i.yRelative=w):(i.z=a,i.zRelative=w),o++}return{result:i,argIndex:o}}}class _ extends F{constructor(){super(...arguments);this.prefix=P.prefix;this._registrationInformation=[];this.customArgTypes=new Map}register(o,r){this._registrationInformation.push({name:o.name.toLowerCase(),aliases:o.aliases?o.aliases.map(i=>i.toLowerCase()):null,description:o.description,usage:o.usage??[],permission:o.permission,callback:r})}getAll(){const o=[];return this._registrationInformation.forEach(r=>{o.push(r.name)}),o}getAllRegistation(){return this._registrationInformation}getRegistration(o){if(!this._registrationInformation.some(m=>m.name.toLowerCase()===o||m.aliases&&m.aliases.includes(o)))return;let i;return this._registrationInformation.forEach(m=>{(m.name.toLowerCase()===o||m.aliases&&m.aliases.includes(o))&&(i=m)}),i}addCustomArgType(o,r){this.customArgTypes.set(o,r)}printCommandArguments(o,r){const i=this.getRegistration(o);if(!i)return;const m=[];function f(w,a,l="_"){const s=[...w];let n=!1,e;l.charAt(0)!="_"&&s.push(l),a?.forEach(t=>{if((!("flag"in t)||t.flag&&t.name)&&e&&(s.push(e+"]"),e=null),"subName"in t){if(n=!0,r&&!N.hasPermission(r,t.permission))return;f(s,t.args,t.subName)}else if("flag"in t)e||(e="[-"),e+=t.flag,t.name&&(s.push(e+` <${t.name}: ${t.type}>]`),e=null);else{let u=t.default?"[":"<";u+=t.name+": ","range"in t&&typeof t.range[0]=="number"&&typeof t.range[1]=="number"?u+=t.range[0]+".."+t.range[1]:u+=t.type,s.push(u+(t.default?"]":">"))}}),e&&(s.push(e+"]"),e=null),n||m.push(s.join(" "))}return r&&!N.hasPermission(r,i.permission)?[]:i.usage.length?(f([],i.usage),m):[""]}parseArgs(o,r){const i=new Map,m=this.getRegistration(o)?.usage;if(m==null)return;const f=(a,l,s)=>{let n=l.type,e;if(n.endsWith("...")&&(n=n.replace("...","")),n==="int"||n==="float"){const t=(n==="int"?parseInt:parseFloat)(r[a]);if(t!=t||isNaN(t))throw y.translate("commands.generic.num.invalid").with(r[a]);const u=l.range;if(u){const C=t<(u[0]??-1/0),k=t>(u[1]??1/0);if(C)throw y.translate("commands.generic.wedit:tooSmall").with(t).with(u[0]);if(k)throw y.translate("commands.generic.wedit:tooBig").with(t).with(u[1])}a++,e=t}else if(n=="xz"){const t=v.parseArgs(r,a,!1);a=t.argIndex,e=t.result}else if(n=="xyz"){const t=v.parseArgs(r,a,!0);a=t.argIndex,e=t.result}else if(n=="CommandName"){const t=this.getRegistration(r[a]);if(!t)throw y.translate("commands.generic.unknown").with(r[a]);a++,e=t.name}else if(n=="string")e=r[a++];else if(this.customArgTypes.has(n))try{const t=this.customArgTypes.get(n).parseArgs(r,a);a=t.argIndex,e=t.result}catch(t){throw t.isSyntaxError&&(t.idx=a),t}else throw`Unknown argument type: ${n}`;return l.type.endsWith("...")?(s.has(l.name)||s.set(l.name,[]),s.get(l.name).push(e)):s.set(l.name,e),a},w=(a,l,s,n)=>{let e=0,t=!1,u=[];n=new Map(n),l?.forEach(c=>{"flag"in c&&!n.has(c.flag)&&n.set(c.flag,c)});function C(c,p){let d=!1,A=[];for(;e<l.length&&"subName"in l[e];){const x=l[e];d||(x.subName.startsWith("_")?A.push(x):(t=!0,x.subName==p&&(c=w(c+1,x.args,s,n),s.set(x.subName,!0),d=!0,A=[]))),e++}if(!d&&t&&!A.length)throw{isSyntaxError:!0,stack:R.stack(),idx:g};const I=[];for(const x of A)try{const E=new Map;c=w(g,x.args,E,n),s.set(x.subName,!0),E.forEach((b,S)=>s.set(S,b)),u.forEach((b,S)=>{x.args.map(z=>"flag"in z?z.flag:null).includes(b)&&(s.set(b,!0),u[S]="")}),u=u.filter(b=>b!=="");break}catch(E){I.push(E)}if(I.length!=0&&I.length==A.length)throw I[0];return c}const k=["0","1","2","3","4","5","6","7","8","9"];let g;for(g=a;g<r.length;g++){const c=r[g];if(c.startsWith("-")&&!k.includes(c.charAt(1))){for(const d of c)if(d!="-")if(n.has(d)){s.set(d,!0);const A=n.get(d);A.type!=null&&(g=f(g+1,{name:A.flag+"-"+A.name,type:A.type},s)-1)}else u.push(d);continue}let p;for(;e<(l?.length??0);){if(!("flag"in l[e])){p=l[e];break}e++}if(!p){const d=l[l.length-1];if(d?.type?.endsWith("..."))p=d;else throw{isSyntaxError:!0,stack:R.stack(),idx:g}}"type"in p&&!("flag"in p)?(g=f(g,p,s)-1,e++):"subName"in p&&(g=C(g,c)-1)}for(;e<(l?.length??0);){const c=l[e];if(!("flag"in c))if("type"in c&&c?.default!=null&&!("subName"in c)){const p=c.default.clone?.()??c.default;s.set(c.name,p)}else if("subName"in c)C(g,"");else throw{isSyntaxError:!0,stack:R.stack(),idx:-1};e++}if(u.length!=0)throw y.translate("commands.generic.wedit:invalidFlag").with(u[0]);return g};return w(0,m,i),i}callCommand(o,r,i=[],m){function f(s,n,e){const t=s.slice(e).search(n);return t==-1?-1:t+e}if(!T.getAllRegistation().some(s=>s.name===r||s.aliases&&s.aliases.includes(r)))throw y.translate("commands.generic.unknown").with(`${r}`);let a="";const l=[];if(typeof i=="string"){const s=[];let n=0;for(;n<i.length&&n!=-1;){const e=i[n]=='"';let t;if(e?(n++,t=f(i,/"/,n)):t=f(i,/\s/,n),t==-1){s.push(i.slice(n)),l.push(n);break}else s.push(i.slice(n,t)),l.push(n),n=f(i,/[^\s]/,t+(e?1:0))}a=i,i=s}else{let s=0;for(const n of i)l.push(s),a+=n+" ",s=a.length;a=i.join(" ")}l.forEach((s,n)=>l[n]=s+this.prefix.length+r.length+1),a=this.prefix+r+" "+a;for(const s of T.getAllRegistation()){if(!(s.name==r||s.aliases?.includes(r)))continue;let n;try{if(s.permission&&!N.hasPermission(o,s.permission))throw y.translate("commands.generic.wedit:noPermission");const e=this.parseArgs(r,i);n=m?.noCallback?new L:s.callback(o,a,e),this.emit("runCommand",o,r,i,n)}catch(e){if(e.isSyntaxError){if(e.idx==-1||e.idx>=i.length)throw y.translate("commands.generic.syntax").with(a).with("").with("");{let t=l[e.idx];e.start&&(t+=e.start);let u=t+i[e.idx].length;throw e.end&&(u=t+e.end),y.translate("commands.generic.syntax").with(a.slice(0,t)).with(a.slice(t,u)).with(a.slice(u))}}else throw e instanceof y?e:(R.error(e,e.stack),y.text(e))}return n}}}const T=new _;export{T as Command,_ as CommandBuilder,v as CommandPosition,tt as CustomArgType};
