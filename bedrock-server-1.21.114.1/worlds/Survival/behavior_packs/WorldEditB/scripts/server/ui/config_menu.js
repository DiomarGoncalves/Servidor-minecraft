import{ItemStack as R}from"@minecraft/server";import{HotbarUI as g}from"server/modules/hotbar_ui.js";import{Mask as S}from"server/modules/mask.js";import{Pattern as P}from"server/modules/pattern.js";import{regionSize as j,Server as a}from"library/Minecraft.js";import{SphereBrush as O}from"../brushes/sphere_brush.js";import{CylinderBrush as v}from"../brushes/cylinder_brush.js";import{SmoothBrush as E}from"../brushes/smooth_brush.js";import{Tools as f}from"../tools/tool_manager.js";import{selectionModes as G}from"server/modules/selection.js";import p from"config.js";import{StructureBrush as W}from"server/brushes/structure_brush.js";import{getSession as b}from"server/sessions.js";import{ErosionBrush as N}from"server/brushes/erosion_brush.js";import{OverlayBrush as A}from"server/brushes/overlay_brush.js";const T=[],m={$usePicker:{type:"toggle",name:"%worldedit.config.usePicker",default:(e,o)=>l(e,o,"mask")?.toJSON()=="(picked)"}},y={$size:{type:"slider",name:"%worldedit.config.radius",min:1,max:p.maxBrushRadius,default:(e,o)=>e.getData("creatingTool")?3:l(e,o,"brush").getSize()}},D={$mask:{type:"textField",name:"%worldedit.config.mask",placeholder:"Eg: air %gametest.optionalPrefix",default:(e,o)=>e.getData("creatingTool")?"":l(e,o,"mask")?.toJSON()??""}},B={$pattern:{type:"textField",name:"%worldedit.config.pattern",placeholder:"Eg: stone,dirt",default:(e,o)=>e.getData("creatingTool")?"":l(e,o,"brush").getPattern().toJSON()}};function C(e){return{translate:new R(e).localizationKey}}function u(e){return{rawtext:[{translate:"accessibility.textbox.editing"},{text:": "},C(e.getData("currentItem"))]}}function l(e,o,t){return f.getProperty(e.getData("currentItem"),o.id,t)}function H(e,o){return f.getBoundItems(e.id,o?"brush":/^.*(?<!brush)$/)}function L(e,o){return e.getData("creatingTool")??f.getBindingType(e.getData("currentItem"),o.id)}function s(e){e.goto("$confirmToolBind")}function k(e){let o;try{if((o=new P(e)).empty())return"worldedit.config.pattern.noPattern"}catch{return"worldedit.config.pattern.invalidPattern"}return o}function _(e){let o;try{o=new S(e)}catch{return"worldedit.config.mask.invalidMask"}return o}a.uiForms.register("$configMenu",{title:"%worldedit.config.mainMenu",buttons:[{text:"%worldedit.config.general",icon:"textures/ui/gear",action:e=>e.goto("$generalOptions")},{text:"%worldedit.config.tools",icon:"textures/ui/tool_config",action:e=>{e.setData("editingBrush",!1),e.goto("$tools")}},{text:"%worldedit.config.brushes",icon:"textures/ui/brush_config",action:e=>{e.setData("editingBrush",!0),e.goto("$tools")}},{text:"%worldedit.config.gradients",icon:"textures/ui/gradient_config",action:e=>e.goto("$gradients")}]}),a.uiForms.register("$generalOptions",{title:"%worldedit.config.general",inputs:{$includeEntities:{name:"%worldedit.config.general.includeEntities",type:"toggle",default:e=>e.getData("session").includeEntities},$includeAir:{name:"%worldedit.config.general.includeAir",type:"toggle",default:e=>e.getData("session").includeAir},$perfMode:{name:"%worldedit.config.general.perfMode",type:"toggle",default:e=>e.getData("session").performanceMode||p.performanceMode},$drawOutlines:{name:"%worldedit.config.general.drawOutlines",type:"dropdown",options:["%worldedit.config.general.drawOutlines.off","%worldedit.config.general.drawOutlines.self","%worldedit.config.general.drawOutlines.all"],default:e=>{const o=e.getData("session").drawOutlines;return o?o==="local"?1:2:0}},$selectionMode:{name:"%worldedit.config.general.selectMode",type:"dropdown",options:["%worldedit.selectionMode.cuboid","%worldedit.selectionMode.extend","%worldedit.selectionMode.sphere","%worldedit.selectionMode.cylinder"],default:e=>G.indexOf(e.getData("session").selection.mode)}},submit:(e,o,t)=>{const r=e.getData("session");r.includeAir=t.$includeAir,r.includeEntities=t.$includeEntities,r.performanceMode=t.$perfMode,r.drawOutlines=[!1,"local",!0][t.$drawOutlines],r.selection.mode=G[t.$selectionMode],e.returnto("$configMenu")},cancel:e=>e.returnto("$configMenu")}),a.uiForms.register("$tools",{title:e=>"%worldedit.config."+(e.getData("editingBrush")?"brushes":"tools"),buttons:(e,o)=>{const t=[];t.push({text:r=>"%worldedit.config.new"+(r.getData("editingBrush")?"Brush":"Tool"),action:(r,n)=>{g.goto("$chooseItem",n,r)}});for(const r of H(o,e.getData("editingBrush"))){const n=f.getBindingType(r,o.id);t.push({text:{rawtext:[{text:"|-- "},C(r),{text:" --|"}]},action:i=>{i.setData("creatingTool",null),i.setData("currentItem",r),T.includes(n)?i.goto(`$editTool_${n}`):n=="brush"?i.goto(`$editTool_${f.getProperty(r,o.id,"brush").id}`):i.goto("$toolNoConfig")}})}return t.length>1&&t.push({text:"Delete tool(s)",action:r=>{r.goto("$deleteTools")}}),t},cancel:e=>e.returnto("$configMenu")}),a.uiForms.register("$gradients",{title:"%worldedit.config.gradients",buttons:(e,o)=>{const t=[];t.push({text:"%worldedit.config.newGradient",action:r=>r.goto("$addGradient")});for(const r of b(o).getGradientNames())t.push({text:r,action:n=>{n.setData("currentGradient",r),n.goto("$gradientInfo")}});return t}}),a.uiForms.register("$gradientInfo",{title:e=>e.getData("currentGradient"),buttons:[{text:"%worldedit.config.gradient.use",action:(e,o)=>{const t=b(o);t.globalPattern=new P(`$${e.getData("currentGradient")}`)}},{text:"%worldedit.config.gradient.remove",action:e=>e.confirm("$worldedit.config.confirm","%worldedit.config.confirm.delete",(o,t)=>{b(t).deleteGradient(o.getData("currentGradient"))})}]}),a.uiForms.register("$addGradient",{title:"%worldedit.config.gradient.add",inputs:{$id:{type:"textField",name:"%worldedit.config.name",placeholder:"%worldedit.config.gradient.promptName"},$dither:{type:"slider",name:"%worldedit.config.blend",min:0,max:1,default:1}},submit:(e,o,t)=>{const r=t.$id;if(!r.length)return e.error("worldedit.config.gradient.noId");if(b(o).getGradient(r))return e.error("worldedit.config.gradient.dupeId");e.setData("pickerData",{return:"$gradients",onFinish:(n,i)=>{n.setData("gradientData",[r,t.$dither,...b(i).selection.getRange()]),n.goto("$confirmGradientSelection")}}),g.goto("$selectBlocks",o,e)},cancel:e=>e.returnto("$gradients")}),a.uiForms.register("$confirmGradientSelection",{title:"%worldedit.config.confirm",message:"%worldedit.config.confirm.create",button1:{text:"%dr.button.ok",action:(e,o)=>{const t=e.getData("session"),[r,n,i,d]=e.getData("gradientData"),c=j(i,d),J=o.dimension,I=[];let h,$,w;c.x>c.y&&c.x>c.z?(h="y",$="z",w="x"):c.z>c.x&&c.z>c.y?(h="x",$="y",w="z"):(h="x",$="z",w="y");for(let M=i[w];M<=d[w];M++){const z=new P;for(let F=i[h];F<=d[h];F++)for(let x=i[$];x<=d[$];x++)z.addBlock(J.getBlock({[h]:F,[$]:x,[w]:M}).permutation);I.push(z)}t.createGradient(r,n,I),e.returnto("$gradients")}},button2:{text:"%gui.cancel",action:e=>e.returnto("$gradients")},cancel:e=>e.returnto("$gradients")}),a.uiForms.register("$toolNoConfig",{title:"%worldedit.config.tool.noProps",message:`%worldedit.config.tool.noProps.detail 


`,buttons:[{text:"%dr.button.ok",action:e=>e.returnto("$tools")}],cancel:e=>e.returnto("$tools")}),a.uiForms.register("$editTool_stacker_wand",{title:u,inputs:{$range:{type:"slider",name:"%worldedit.config.range",min:1,max:p.traceDistance,default:(e,o)=>e.getData("creatingTool")?5:l(e,o,"range")},...D,...m},submit:(e,o,t)=>{t.$usePicker?(e.setData("pickerData",{return:"$editTool_stacker_wand",onFinish:(r,n,i)=>{r.setData("toolData",[t.$range,i]),s(r)}}),g.goto("$pickMask",o,e)):(e.setData("toolData",[t.$range,new S(t.$mask)]),s(e))},cancel:e=>e.returnto("$tools")}),T.push("stacker_wand"),a.uiForms.register("$editTool_extruder_wand",{title:u,inputs:{$range:{type:"slider",name:"%worldedit.config.range",min:1,max:p.traceDistance,default:(e,o)=>e.getData("creatingTool")?5:l(e,o,"range")},$mode:{type:"dropdown",name:"%worldedit.config.mode",options:["%worldedit.extruderMode.pull","%worldedit.extruderMode.dig"],default:(e,o)=>e.getData("creatingTool")?0:l(e,o,"digging")?1:0}},submit:(e,o,t)=>{e.setData("toolData",[t.$range,!!t.$mode]),s(e)},cancel:e=>e.returnto("$tools")}),T.push("extruder_wand"),a.uiForms.register("$editTool_command_wand",{title:u,inputs:{$command:{type:"textField",name:"%worldedit.config.command",placeholder:"Enter here (without ; or /)",default:(e,o)=>e.getData("creatingTool")?"":l(e,o,"command")},$worldeditCmd:{type:"toggle",name:"%worldedit.config.command.isWorldEdit",default:(e,o)=>e.getData("creatingTool")?!1:l(e,o,"isCustom")}},submit:(e,o,t)=>{if(!t.$command.length)return e.error("worldedit.config.command.noCommand");e.setData("toolData",[(t.$worldeditCmd?p.commandPrefix:"/")+t.$command]),s(e)},cancel:e=>e.returnto("$tools")}),T.push("command_wand"),a.uiForms.register("$editTool_replacer_wand",{title:u,inputs:{$pattern:{type:"textField",name:"%worldedit.config.pattern",placeholder:"Eg: stone,dirt",default:(e,o)=>e.getData("creatingTool")?"":l(e,o,"pattern").toJSON()},...m},submit:(e,o,t)=>{if(t.$usePicker)e.setData("pickerData",{return:"$editTool_replacer_wand",onFinish:(r,n,i,d)=>{r.setData("toolData",[d]),s(r)}}),g.goto("$pickPattern",o,e);else{const r=k(t.$pattern);if(typeof r=="string")return e.error(r);e.setData("toolData",[r]),s(e)}},cancel:e=>e.returnto("$tools")}),T.push("replacer_wand"),a.uiForms.register("$editTool_sphere_brush",{title:u,inputs:{...y,...B,...D,$hollow:{type:"toggle",name:"%worldedit.config.hollow",default:(e,o)=>e.getData("creatingTool")?!1:l(e,o,"brush").isHollow()},...m},submit:(e,o,t)=>{if(t.$usePicker)e.setData("pickerData",{return:"$editTool_sphere_brush",onFinish:(r,n,i,d)=>{r.setData("toolData",[new O(t.$size,d,t.$hollow),i,null,null]),s(r)}}),g.goto("$pickPatternMask",o,e);else{const r=k(t.$pattern);if(typeof r=="string")return e.error(r);const n=_(t.$mask);if(typeof n=="string")return e.error(n);e.setData("toolData",[new O(t.$size,r,t.$hollow),n,null,null]),s(e)}},cancel:e=>e.returnto("$tools")}),a.uiForms.register("$editTool_cylinder_brush",{title:u,inputs:{...y,$height:{type:"slider",name:"%worldedit.config.height",min:1,max:p.maxBrushRadius*2,default:(e,o)=>e.getData("creatingTool")?1:l(e,o,"brush").getHeight()},...B,...D,$hollow:{type:"toggle",name:"%worldedit.config.hollow",default:(e,o)=>e.getData("creatingTool")?!1:l(e,o,"brush").isHollow()},...m},submit:(e,o,t)=>{if(t.$usePicker)e.setData("pickerData",{return:"$editTool_cylinder_brush",onFinish:(r,n,i,d)=>{r.setData("toolData",[new v(t.$size,t.$height,d,t.$hollow),i,null,null]),s(r)}}),g.goto("$pickPatternMask",o,e);else{const r=k(t.$pattern);if(typeof r=="string")return e.error(r);const n=_(t.$mask);if(typeof n=="string")return e.error(n);e.setData("toolData",[new v(t.$size,t.$height,r,t.$hollow),n,null,null]),s(e)}},cancel:e=>e.returnto("$tools")}),a.uiForms.register("$editTool_smooth_brush",{title:u,inputs:{...y,...D,$iterations:{type:"slider",name:"%worldedit.config.smooth",min:1,max:6,default:(e,o)=>e.getData("creatingTool")?1:l(e,o,"brush").getIterations()},$heightMask:{type:"textField",name:"%worldedit.config.mask.height",placeholder:"Eg: grass,stone %gametest.optionalPrefix",default:(e,o)=>e.getData("creatingTool")?"":l(e,o,"brush").getHeightMask()?.toJSON()??""},...m},submit:(e,o,t)=>{const r=_(t.$heightMask);if(typeof r=="string")return e.error(r);if(t.$usePicker)e.setData("pickerData",{return:"$editTool_smooth_brush",onFinish:(n,i,d)=>{n.setData("toolData",[new E(t.$size,t.$iterations,r),d,null,null]),s(n)}}),g.goto("$pickMask",o,e);else{const n=_(t.$mask);if(typeof n=="string")return e.error(n);e.setData("toolData",[new E(t.$size,t.$iterations,r),n,null,null]),s(e)}},cancel:e=>e.returnto("$tools")}),a.uiForms.register("$editTool_structure_brush",{title:u,inputs:{$structs:{type:"textField",name:"%worldedit.config.structures",placeholder:"Leave blank for current clipboard",default:(e,o)=>e.getData("creatingTool")?"":l(e,o,"brush").imports?.join(" ")??""}},submit:(e,o,t)=>{e.setData("toolData",[new W(t.$structs?t.$structs.split(" "):b(o).clipboard,null),null,null,null]),s(e)},cancel:e=>e.returnto("$tools")}),a.uiForms.register("$editTool_erosion_brush",{title:u,inputs:{...y,$erosion:{type:"dropdown",name:"%worldedit.config.erosion",options:["Erode","Lift","Fill","Melt","Smooth"],default:(e,o)=>e.getData("creatingTool")?0:l(e,o,"brush").getType()},...D,...m},submit:(e,o,t)=>{if(t.$usePicker)e.setData("pickerData",{return:"$editTool_erosion_brush",onFinish:(r,n,i)=>{r.setData("toolData",[new N(t.$size,t.$erosion),i,null,null]),s(r)}}),g.goto("$pickMask",o,e);else{const r=_(t.$mask);if(typeof r=="string")return e.error(r);e.setData("toolData",[new N(t.$size,t.$erosion),r,null,null]),s(e)}},cancel:e=>e.returnto("$tools")}),a.uiForms.register("$editTool_overlay_brush",{title:u,inputs:{...y,...B,$depth:{type:"slider",name:"%worldedit.config.depth",min:-10,max:10,default:(e,o)=>e.getData("creatingTool")?1:l(e,o,"brush").getDepth()},...D,...m},submit:(e,o,t)=>{if(t.$usePicker)e.setData("pickerData",{return:"$editTool_overlay_brush",onFinish:(r,n,i,d)=>{r.setData("toolData",[new A(t.$size,t.$depth,d,null),i,null,null]),s(r)}}),g.goto("$pickPatternMask",o,e);else{const r=k(t.$pattern);if(typeof r=="string")return e.error(r);const n=_(t.$mask);if(typeof n=="string")return e.error(n);e.setData("toolData",[new A(t.$size,t.$depth,r,null),n,null,null]),s(e)}},cancel:e=>e.returnto("$tools")}),a.uiForms.register("$selectToolType",{title:"%worldedit.config.choose.tool",buttons:[{text:"%worldedit.config.tool.selection",icon:"textures/ui/selection_wand",action:e=>{e.setData("creatingTool","selection_wand"),s(e)}},{text:"%worldedit.config.tool.far_selection",icon:"textures/ui/far_selection_wand",action:e=>{e.setData("creatingTool","far_selection_wand"),s(e)}},{text:"%worldedit.config.tool.navigation",icon:"textures/ui/navigation_wand",action:e=>{e.setData("creatingTool","navigation_wand"),s(e)}},{text:"%worldedit.config.tool.stacker",icon:"textures/ui/stacker_wand",action:e=>{e.setData("creatingTool","stacker_wand"),e.goto("$editTool_stacker_wand")}},{text:"%worldedit.config.tool.extruder",icon:"textures/ui/extruder_wand",action:e=>{e.setData("creatingTool","extruder_wand"),e.goto("$editTool_extruder_wand")}},{text:"%worldedit.config.tool.cmd",icon:"textures/ui/command_wand",action:e=>{e.setData("creatingTool","command_wand"),e.goto("$editTool_command_wand")}},{text:"%worldedit.config.tool.repl",icon:"textures/ui/replacer_wand",action:e=>{e.setData("creatingTool","replacer_wand"),e.goto("$editTool_replacer_wand")}},{text:"%worldedit.config.tool.cycle",icon:"textures/ui/cycler_wand",action:e=>{e.setData("creatingTool","cycler_wand"),s(e)}}],cancel:e=>e.returnto("$tools")}),a.uiForms.register("$selectBrushType",{title:"%worldedit.config.choose.brush",buttons:[{text:"%worldedit.config.brush.sphere",icon:"textures/ui/sphere_brush",action:e=>{e.setData("creatingTool","sphere_brush"),e.goto("$editTool_sphere_brush")}},{text:"%worldedit.config.brush.cylinder",icon:"textures/ui/cylinder_brush",action:e=>{e.setData("creatingTool","cylinder_brush"),e.goto("$editTool_cylinder_brush")}},{text:"%worldedit.config.brush.smooth",icon:"textures/ui/smooth_brush",action:e=>{e.setData("creatingTool","smooth_brush"),e.goto("$editTool_smooth_brush")}},{text:"%worldedit.config.brush.struct",icon:"textures/ui/structure_brush",action:e=>{e.setData("creatingTool","structure_brush"),e.goto("$editTool_structure_brush")}},{text:"%worldedit.config.brush.erode",icon:"textures/ui/erosion_brush",action:e=>{e.setData("creatingTool","erosion_brush"),e.goto("$editTool_erosion_brush")}},{text:"%worldedit.config.brush.overlay",icon:"textures/ui/overlay_brush",action:e=>{e.setData("creatingTool","overlay_brush"),e.goto("$editTool_overlay_brush")}}],cancel:e=>e.returnto("$tools")}),a.uiForms.register("$confirmToolBind",{title:"%worldedit.config.confirm",message:"%worldedit.config.confirm.create",button1:{text:"%dr.button.ok",action:(e,o)=>{const t=e.getData("session"),r=L(e,o),n=e.getData("currentItem"),i=e.getData("toolData")??[];r.endsWith("brush")?(t.bindTool("brush",n,i[0],i[1]),f.setProperty(n,o.id,"range",i[2]),f.setProperty(n,o.id,"traceMask",i[3])):t.bindTool(r,n,...i),e.returnto("$tools")}},button2:{text:"%gui.cancel",action:e=>e.returnto("$tools")},cancel:e=>e.returnto("$tools")}),a.uiForms.register("$confirmDelete",{title:"%worldedit.config.confirm",message:e=>{const o=e.getData("deletingTools"),t=[{translate:"worldedit.config.confirm.delete"}];for(const r of o)t.push({text:`
`},C(r));return{rawtext:t}},button1:{text:"%dr.button.ok",action:e=>{const o=e.getData("session");for(const t of e.getData("deletingTools"))o.unbindTool(t);e.returnto("$tools")}},button2:{text:"%gui.cancel",action:e=>e.returnto("$tools")},cancel:e=>e.returnto("$tools")}),a.uiForms.register("$deleteTools",{title:"%gui.delete",inputs:(e,o)=>{const t={};for(const r of H(o,e.getData("editingBrush")))t[`$${r}`]={name:C(r),type:"toggle"};return t},submit:(e,o,t)=>{const r=[];for(const[n,i]of Object.entries(t))if(i){const d=n.slice(1);r.push(d)}r.length?(e.setData("deletingTools",r),e.goto("$confirmDelete")):e.returnto("$tools")},cancel:e=>e.returnto("$tools")});
