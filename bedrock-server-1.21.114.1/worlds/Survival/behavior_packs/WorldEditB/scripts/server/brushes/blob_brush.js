import{regionIterateBlocks as z,Vector as d}from"library/Minecraft.js";import{brushTypes as E,Brush as Z}from"./base_brush.js";import{Pattern as q}from"server/modules/pattern.js";import{Jobs as M}from"server/modules/jobs.js";import{getWorldHeightLimits as v}from"server/util.js";import{SphereShape as I}from"server/shapes/sphere.js";class J extends Z{constructor(t,h,f=50,g=0){super();this.id="blob_brush";this.assertSizeInRange(t),this.growPercent=f,this.smoothness=g,this.pattern=h,this.radius=t}resize(t){this.assertSizeInRange(t),this.radius=t}getSize(){return this.radius}paintWith(t){this.pattern=t}getPattern(){return this.pattern}*apply(t,h,f){const g=h.player.dimension,[y,b]=[t.sub(this.radius),t.add(this.radius)],k=this.pattern.withContext(h,[y,b]);f=f?.withContext(h);const[B,N]=v(g);y.y=Math.max(B,y.y),b.y=Math.min(N,b.y);const a=this.radius,O=this.smoothness,c=2*a,R=this.growPercent/100;let e=Array.from({length:c+1},()=>Array.from({length:c+1},()=>Array(c+1).fill(0))),l=Array.from({length:c+1},()=>Array.from({length:c+1},()=>Array(c+1).fill(0)));e[a][a][a]=1,yield*M.run(h,1,function*(){for(let i=0;i<a*Math.SQRT2;i++){for(const{x:r,y:o,z:n}of z(d.ZERO,d.ONE.mul(c)))if(e[r][o][n]===0){let s=0;e[r-1]?.[o][n]===1&&s++,e[r][o-1]?.[n]===1&&s++,e[r][o][n-1]===1&&s++,e[r+1]?.[o][n]===1&&s++,e[r][o+1]?.[n]===1&&s++,e[r][o][n+1]===1&&s++,l[r][o][n]=+(s>=1&&Math.random()<=R)}else l[r][o][n]=1;const u=e;e=l,l=u,yield}for(let i=0;i<O*3;i++){const u=i%3,r=+(u===0),o=+(u===1),n=+(u===2);for(const{x:m,y:p,z:w}of z(d.ZERO,d.ONE.mul(c))){let x=e[m][p][w]*1.4;x+=(e[m+r]?.[p+o]?.[w+n]??0)*.8,x+=(e[m-r]?.[p-o]?.[w-n]??0)*.8,l[m][p][w]=x/3}const s=e;e=l,l=s,yield}const A=Math.pow(a+1,2),S=h.history,P=S.record();try{yield*S.trackRegion(P,y,b);for(let i=c;i>=0;i--){const u=Math.pow(i-a-1,2);for(let r=c;r>=0;r--){const o=t.y-a+r;if(o<y.y||o>b.y)continue;const n=Math.pow(r-a-1,2);for(let s=c;s>=0;s--)if(e[i][r][s]>.5&&u+n+Math.pow(s-a-1,2)<=A){const m=new d(t.x-a+i,o,t.z-a+s),p=g.getBlock(m)??(yield*M.loadBlock(m));(!f||f.matchesBlock(p))&&k.setBlock(p),yield}}}yield*S.commit(P)}catch(i){throw S.cancel(P),i}})}getOutline(){return[new I(this.radius),d.ZERO]}toJSON(){return{id:this.id,radius:this.radius,pattern:this.pattern,growPercent:this.growPercent,smoothness:this.smoothness}}static parseJSON(t){return[t.radius,new q(t.pattern),t.growPercent,t.smoothness]}}E.set("blob_brush",J);export{J as BlobBrush};
