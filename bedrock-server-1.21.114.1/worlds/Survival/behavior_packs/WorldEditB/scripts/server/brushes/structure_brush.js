import{Vector as o}from"library/Minecraft.js";import{brushTypes as p,Brush as d}from"./base_brush.js";import{world as l}from"@minecraft/server";import{importStructure as g}from"server/commands/structure/import.js";import{CuboidShape as y}from"server/shapes/cuboid.js";class z extends d{constructor(t,e){super();this.id="structure_brush";this.randomTransform=!0;this.lastTransform=[0,new o(1,1,1)];Array.isArray(t)&&typeof t[0]=="string"&&(this.imports=t,t=this.imports.map(r=>g(r,l.getPlayers()[0]).buffer)),t=t,this.structs=Array.isArray(t)?t:[t],this.mask=e,this.updateStructIdx();for(const r of this.structs)r.ref()}resize(){throw"commands.generic.wedit:noSize"}getSize(){return-1}getMask(){return this.mask}paintWith(){throw"commands.generic.wedit:noMaterial"}*apply(t,e){const r=e.history,n=r.record();try{const c=this.structs[this.structIdx],h=c.getSize();let i=t.offset(-h.x/2,1,-h.z/2).ceil(),m=i.add(h).sub(1);const u=i.add(m.add(1)).mul(.5),f=this.mask?.withContext(e),a={offset:i.sub(u),mask:f};if(this.randomTransform){const s=this.lastTransform.slice();for(;s[0]==this.lastTransform[0]&&s[1].equals(this.lastTransform[1]);)s[0]=[0,90,180,-90][Math.floor(Math.random()*4)],s[1]=new o(Math.random()>.5?1:-1,1,Math.random()>.5?1:-1);a.rotation=new o(0,s[0],0),a.scale=s[1],this.lastTransform=s,[i,m]=c.getBounds(u,a)}yield*r.trackRegion(n,i,m),yield*c.load(u,e.player.dimension,a),yield*r.commit(n)}catch{r.cancel(n)}this.updateStructIdx()}getOutline(){return[new y(...this.size.toArray()),new o(-this.size.x/2,1,-this.size.z/2).ceil()]}delete(){for(const t of this.structs)t.deref()}updateStructIdx(){this.structIdx=Math.floor(Math.random()*this.structs.length),this.size=this.structs[this.structIdx].getSize(),this.randomTransform&&(this.size=new o(Math.max(this.size.x,this.size.z),this.size.y,Math.max(this.size.x,this.size.z)))}}p.set("structure_brush",z);export{z as StructureBrush};
