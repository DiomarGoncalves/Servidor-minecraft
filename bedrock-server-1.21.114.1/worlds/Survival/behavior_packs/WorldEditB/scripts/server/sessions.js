import{system as b}from"@minecraft/server";import{Server as n,Vector as c,setTickTimeout as y,contentLog as p,Databases as g,everyCall as f}from"library/Minecraft.js";import{Tools as l}from"./tools/tool_manager.js";import{createHistoryBufferForSession as m}from"server/modules/history.js";import{Mask as P}from"server/modules/mask.js";import{Pattern as u}from"server/modules/pattern.js";import{PlayerUtil as h}from"server/modules/player_util.js";import{RegionBuffer as S}from"server/modules/region_buffer.js";import{createSelectionForPlayer as w}from"server/modules/selection.js";import o from"config.js";const r=new Map,a=new Map;n.on("playerChangeDimension",t=>{r.get(t.player.id)?.selection.clear()}),g.addParser((t,e,i)=>{if(i==="gradients"&&e&&typeof e=="object"&&e.patterns)try{return e.patterns=e.patterns.map(s=>new u(s)),e}catch{p.error(`Failed to load gradient ${t}`)}else return e}),b.afterEvents.scriptEventReceive.subscribe(({id:t,sourceEntity:e})=>{t!=="wedit:reset_gradients_database"||!e||g.delete("gradients",e)});class v{constructor(e){this.usingItem=!1;this.globalPattern=new u;this.globalMask=new P;this.includeEntities=!1;this.includeAir=!1;this.performanceMode=!1;this.changeLimit=o.defaultChangeLimit==-1?1/0:o.defaultChangeLimit;this.clipboardTransform={offset:c.ZERO,rotation:c.ZERO,scale:c.ONE};this.superPickaxe={enabled:!1,mode:"single",range:0};this.regions=new Map;this.lazySelectionDraw=f(8);this.lazyLoftDraw=f(9);this.placementMode="player";this.player=e,this.playerId=e.id,this.gradients=g.load("gradients",e),this.selection=w(e),this.history=m(this),this.selection.visible=o.drawOutlines,this.getTools().length||(this.bindTool("selection_wand",o.wandItem),this.bindTool("navigation_wand",o.navWandItem)),h.isHotbarStashed(e)&&h.restoreHotbar(e);for(const i of e.getTags())i.startsWith("wedit:defaultTag_")&&(this.selection.mode=i.split("_",2)[1])}set drawOutlines(e){this.selection.visible=e}get drawOutlines(){return this.selection.visible}set clipboard(e){this.clipboardBuffer!==e&&(this.deleteRegion(this.clipboardBuffer),this.clipboardBuffer=e)}get clipboard(){return this.clipboardBuffer}togglePlacementPosition(){this.placementMode=this.placementMode=="player"?"selection":"player"}getPlacementPosition(){if(this.placementMode=="player")return c.from(this.player.location).floor();{const e=this.selection.points[0];if(!e)throw"";return e.clone()}}bindTool(e,i,...s){return i||(i=n.player.getHeldItem(this.player)?.typeId),l.bind(e,i,this.playerId,...s)}hasToolProperty(e,i){return e||(e=n.player.getHeldItem(this.player)?.typeId),l.hasProperty(e,this.playerId,i)}setToolProperty(e,i,s){return e||(e=n.player.getHeldItem(this.player)?.typeId),l.setProperty(e,this.playerId,i,s)}hasTool(e){return e||(e=n.player.getHeldItem(this.player)?.typeId),l.hasBinding(e,this.playerId)}unbindTool(e){return e||(e=n.player.getHeldItem(this.player)?.typeId),l.unbind(e,this.playerId)}getTools(e){return l.getBoundItems(this.playerId,e)}enterSettings(){n.uiForms.show("$configMenu",this.player,{session:this})}*createRegion(e,i,s={}){const d=yield*S.createFromWorld(e,i,this.player.dimension,{...s,recordBlocksWithData:(s.recordBlocksWithData??!0)&&!o.performanceMode&&!this.performanceMode});if(d)return this.regions.set(d.id,d),d}deleteRegion(e){this.regions.has(e?.id)&&(this.regions.delete(e?.id),e?.deref())}createGradient(e,i,s){this.gradients.data[e]={dither:i,patterns:s},this.gradients.save()}getGradient(e){return this.gradients.data[e]}getGradientNames(){return Object.keys(this.gradients.data)}deleteGradient(e){delete this.gradients.data[e],this.gradients.save()}delete(){for(const e of this.regions.values())e.deref();this.regions.clear(),this.history.clear()}onTick(){if(this.selection.visible&&(this.loft&&this.lazyLoftDraw(()=>this.loft.draw(this.player,c.ZERO,this.selection.visible==="local")),!this.selection.isEmpty)){const[e,i]=this.selection.getShape()??[void 0,void 0];e&&this.lazySelectionDraw(()=>e.draw(this.player,i,this.selection.visible==="local"))}}}function N(t){const e=t.id;if(!r.has(e)){let i;a.has(e)&&(i=a.get(e)[1],a.delete(e)),r.set(e,i??new v(t)),p.debug(r.get(e)?.player?.name+` (${e})`),p.debug(`new Session?: ${!i}`)}return r.get(e)}function A(t){r.has(t)&&(r.get(t).selection.clear(),r.get(t).globalPattern.clear(),a.set(t,[o.ticksToDeleteSession,r.get(t)]),r.delete(t))}function U(t){return r.has(t)}y(()=>{n.prependListener("tick",()=>{for(const t of a.keys()){const e=a.get(t);e[0]--,e[0]<0&&(e[1].delete(),a.delete(t),p.log(`session for player ${t} has been deleted.`))}for(const t of r.values())t.onTick()})},1);export{v as PlayerSession,N as getSession,U as hasSession,A as removeSession};
