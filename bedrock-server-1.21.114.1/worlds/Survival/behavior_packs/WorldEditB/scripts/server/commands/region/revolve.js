import{assertCuboidSelection as P}from"server/modules/assert.js";import{Jobs as y}from"server/modules/jobs.js";import{RawText as b,regionBounds as E,regionOffset as M,Vector as v}from"library/Minecraft.js";import{registerCommand as J}from"../register_commands.js";import{copy as O}from"../clipboard/copy.js";import{RegionBuffer as T}from"server/modules/region_buffer.js";const U={name:"revolve",permission:"worldedit.region.revolve",description:"commands.wedit:revolve.description",usage:[{flag:"a"},{flag:"s"},{name:"count",type:"int",range:[2,null]},{name:"start",type:"float",default:0},{name:"end",type:"float",default:360},{name:"heightDiff",type:"int",default:0},{flag:"d",name:"direction",type:"Direction"},{flag:"m",name:"mask",type:"Mask"}]};J(U,function*(t,l,e){P(t);const f=e.get("count"),s=e.get("d-direction")?.getDirection(l)??v.UP,[g,R]=t.selection.getRange(),w=e.get("heightDiff"),[C,k]=[e.get("start"),e.get("end")],u=v.from(l.location).floor().add(.5),d=g.sub(u),D=l.dimension,m=[],i=[],[S,V]=M(g,R,d.mul(-1));for(let o=0;o<=f;o++){const n=o/f,c=s.mul((1-n)*C+n*k),h=s.mul(Math.round(n*w)),[x,I]=T.createBounds(S,V,{offset:d.add(h),rotation:c});m.push([u.add(h),c]),i.push(x,I)}const B=E(i);let p=0;const r=t.history,a=r.record();return yield*y.run(t,m.length+1,function*(){let o;try{o=yield*O(t,e,!1),yield*r.trackRegion(a,...B);for(const[n,c]of m)yield y.nextStep("Pasting blocks..."),yield*o.load(n,D,{rotation:c,offset:d}),p+=o.getVolume();e.has("s")&&(r.trackSelection(a),t.selection.set(0,i[i.length-2]),t.selection.set(1,i[i.length-1])),yield*r.commit(a)}catch(n){throw r.cancel(a),n}finally{t.deleteRegion(o)}}),b.translate("commands.wedit:revolve.explain").with(p)});
