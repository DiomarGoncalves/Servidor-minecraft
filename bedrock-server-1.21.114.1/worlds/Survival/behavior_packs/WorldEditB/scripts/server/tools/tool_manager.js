import{world as b,system as u}from"@minecraft/server";import{contentLog as B,Databases as f,Server as a,sleep as k,Thread as m,Vector as c}from"library/Minecraft.js";import{ToolAction as g}from"./base_tool.js";import{getSession as r,hasSession as d}from"../sessions.js";const h=new Map;f.addParser((l,t,i)=>{if(i.startsWith("tools|")&&t&&typeof t=="object"&&"toolType"in t)try{const e=h.get(t.toolType),n=new e(...e.parseJSON(t));return n.type=t.toolType,n}catch(e){B.error(`Failed to load tool from '${JSON.stringify(t)}' for '${l}': ${e}`)}else return t}),u.afterEvents.scriptEventReceive.subscribe(({id:l,sourceEntity:t})=>{l!=="wedit:reset_tools_database"||!t||f.delete(`tools|${t.id}`)});class T{constructor(){this.bindings=new Map;this.fixedBindings=new Map;this.prevHeldTool=new Map;this.conditionalBindings=new Map;this.disabled=[];a.on("itemUseBefore",t=>{!t.itemStack||!d(t.source.id)||this.onItemUse(t.itemStack,t.source,t)}),a.on("itemUseOnBefore",t=>{!t.itemStack||!d(t.player.id)||this.onItemUse(t.itemStack,t.player,t,c.from(t.block))}),a.on("entityCreate",({entity:t})=>{if(!t.hasComponent("minecraft:item"))return;const i=t.dimension.getPlayers({closest:1,location:t.location,maxDistance:2})[0];i&&this.onItemDrop(t.getComponent("item").itemStack,i)}),a.on("blockBreak",t=>{!t.itemStack||!d(t.player.id)||this.onBlockBreak(t.itemStack,t.player,t,c.from(t.block))}),a.on("blockHit",t=>{if(t.damagingEntity.typeId!="minecraft:player"||!d(t.damagingEntity.id))return;const i=a.player.getHeldItem(t.damagingEntity);i&&this.onBlockHit(i,t.damagingEntity,t,c.from(t.hitBlock))}),new m().start(function*(t){for(;;){for(const i of b.getPlayers()){if(!d(i.id))break;try{const e=a.player.getHeldItem(i);e?yield*t.onItemTick(e,i,u.currentTick):t.stopHolding(i)}catch(e){B.error(e)}}yield k(1)}},this)}register(t,i,e,n){if(h.set(i,t),typeof e=="string")this.fixedBindings.set(e,new t);else if(n&&Array.isArray(e)){const s={condition:n,tool:new t};for(const o of e)this.conditionalBindings.set(o,s)}}bind(t,i,e,...n){if(this.unbind(i,e),i){const s=new(h.get(t))(...n);return s.type=t,this.createPlayerBindingMap(e),this.bindings.get(e).data[i]?.delete(),this.bindings.get(e).data[i]=s,this.bindings.get(e).save(),s}else throw"worldedit.tool.noItem"}unbind(t,i){if(t){if(this.fixedBindings.has(t))throw"worldedit.tool.fixedBind";this.createPlayerBindingMap(i),this.bindings.get(i).data[t]?.delete(),delete this.bindings.get(i).data[t],this.bindings.get(i).save()}else throw"worldedit.tool.noItem"}hasBinding(t,i){return t?!!this.bindings.get(i)?.data[t]||this.fixedBindings.has(t):!1}getBindingType(t,i){return t?(this.bindings.get(i)?.data[t]||this.fixedBindings.get(t))?.type??"":""}getBoundItems(t,i){this.createPlayerBindingMap(t);const e=this.bindings.get(t).data;return e?Array.from(Object.entries(e)).filter(n=>!i||(typeof i=="string"?n[1].type==i:i.test(n[1].type))).map(n=>n[0]):[]}setProperty(t,i,e,n){if(t){const s=this.bindings.get(i).data[t];if(s&&e in s)return s[e]=n,this.bindings.get(i).save(),!0}return!1}getProperty(t,i,e){if(t){const n=this.bindings.get(i).data[t];if(n&&e in n)return n[e]}return null}hasProperty(t,i,e){if(t){const n=this.bindings.get(i).data[t];if(n&&e in n)return!0}return!1}setDisabled(t,i){i&&!this.disabled.includes(t)?this.disabled.push(t):!i&&this.disabled.includes(t)&&this.disabled.splice(this.disabled.indexOf(t),1)}*onItemTick(t,i,e){if(this.disabled.includes(i.id)||!d(i.id))return this.stopHolding(i);const n=t.typeId;let s;if(this.bindings.get(i.id)?.data[n])s=this.bindings.get(i.id).data[n];else if(this.fixedBindings.has(n))s=this.fixedBindings.get(n);else return this.stopHolding(i);this.prevHeldTool.get(i)!==s&&(this.stopHolding(i),this.prevHeldTool.set(i,s));const o=s.tick?.(i,r(i),e);o&&(yield*o)}onItemUse(t,i,e,n){if(this.disabled.includes(i.id)||!d(i.id))return;const s=t.typeId;let o;if(this.bindings.get(i.id)?.data[s])o=this.bindings.get(i.id).data[s];else if(this.fixedBindings.has(s))o=this.fixedBindings.get(s);else if(this.conditionalBindings.get(s)?.condition(i,r(i)))o=this.conditionalBindings.get(s).tool;else return;n=n?o.onSurface?c.add(n,e.blockFace):n:void 0,o.process(r(i),n?g.USE_ON:g.USE,n)&&(e.cancel=!0)}onBlockBreak(t,i,e,n){if(this.disabled.includes(i.id))return;const s=t.typeId;let o;if(this.bindings.get(i.id)?.data[s])o=this.bindings.get(i.id).data[s];else if(this.fixedBindings.has(s))o=this.fixedBindings.get(s);else if(this.conditionalBindings.get(s)?.condition(i,r(i)))o=this.conditionalBindings.get(s).tool;else return;o.process(r(i),g.BREAK,n)&&(e.cancel=!0)}onBlockHit(t,i,e,n){if(this.disabled.includes(i.id))return;const s=t.typeId;let o;if(this.bindings.get(i.id)?.data[s])o=this.bindings.get(i.id).data[s];else if(this.fixedBindings.has(s))o=this.fixedBindings.get(s);else if(this.conditionalBindings.get(s)?.condition(i,r(i)))o=this.conditionalBindings.get(s).tool;else return;o.process(r(i),g.HIT,n)}onItemDrop(t,i){if(this.disabled.includes(i.id)||!d(i.id))return;const e=t.typeId;let n;if(this.bindings.get(i.id)?.data[e])n=this.bindings.get(i.id).data[e];else if(this.fixedBindings.has(e))n=this.fixedBindings.get(e);else if(this.conditionalBindings.get(e)?.condition(i,r(i)))n=this.conditionalBindings.get(e).tool;else return;n.process(r(i),g.DROP)}createPlayerBindingMap(t){if(this.bindings.has(t))return;const i=f.load(`tools|${t}`);this.bindings.set(t,i)}stopHolding(t){this.prevHeldTool.has(t)&&(this.prevHeldTool.get(t)?.process(r(t),g.STOP_HOLD),this.prevHeldTool.delete(t))}}const A=new T;export{A as Tools};
