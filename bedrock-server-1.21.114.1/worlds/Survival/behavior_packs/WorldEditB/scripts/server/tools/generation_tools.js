import{system as C}from"@minecraft/server";import{PlayerUtil as B}from"server/modules/player_util";import{RawText as y,Server as F,Vector as a,regionBounds as U}from"library/Minecraft.js";import{plotCurve as T,plotLine as V}from"server/commands/region/paths_func";import{Tool as M}from"./base_tool";import{Tools as f}from"./tool_manager";import{print as b,snap as $}from"server/util";import{Jobs as k}from"server/modules/jobs";import{SphereShape as v}from"server/shapes/sphere";import{CylinderShape as D}from"server/shapes/cylinder";import{PyramidShape as O}from"server/shapes/pyramid";import{HotbarUI as R}from"server/modules/hotbar_ui";function c(m,w,e){try{m.spawnParticle(w,e)}catch{}}class _ extends M{constructor(){super(...arguments);this.posStart=new WeakMap}baseUse(e,t,r){if(F.player.isSneaking(e))return F.uiForms.show("$selectGenMode",e),!0;if(t.globalPattern.empty())throw"worldEdit.selectionFill.noPattern";return this.posStart.has(t)?!1:(r&&this.posStart.set(t,[r,e.dimension.id]),!0)}baseTick(e,t){return C.currentTick%5!==0||!this.posStart.has(t)||!t.drawOutlines||this.posStart.get(t)[1]!==e.dimension.id?!0:this.posStart.get(t)[1]!==e.dimension.id?(this.posStart.delete(t),!0):!1}traceForPos(e){return B.traceForBlock(e,8)}getFirstPos(e){return this.posStart.get(e)[0]}clearFirstPos(e){return this.posStart.delete(e)}stopHold(e,t){this.posStart.delete(t)}drop(e,t){this.posStart.delete(t)}}class z extends _{constructor(){super(...arguments);this.permission="worldedit.region.line";this.useOn=this.commonUse;this.use=this.commonUse}*commonUse(e,t,r){if(this.baseUse(e,t,r))return;const o=this.getFirstPos(t),s=this.traceForPos(e),[i,n]=U([o,s]);this.clearFirstPos(t);const l=e.dimension,h=t.globalPattern.withContext(t,[i,n]),d=t.globalMask.withContext(t),u=t.history,P=u.record();let p;try{yield*u.trackRegion(P,i,n),p=0;for(const g of V(o,s)){const S=l.getBlock(g)??(yield*k.loadBlock(g));d.matchesBlock(S)&&h.setBlock(S)&&p++,yield}yield*u.commit(P)}catch(g){throw u.cancel(P),g}b(y.translate("commands.blocks.wedit:created").with(`${p}`),e,!0)}tick(e,t){if(this.baseTick(e,t))return;let r=this.getFirstPos(t);const o=this.traceForPos(e);o.sub(r).length>32&&(r=o.add(r.sub(o).normalized().mul(32)).floor());for(const i of V(r,o))c(e,"wedit:selection_draw",i),c(e,"wedit:selection_draw",a.add(i,[1,0,0])),c(e,"wedit:selection_draw",a.add(i,[0,1,0])),c(e,"wedit:selection_draw",a.add(i,[1,1,0])),c(e,"wedit:selection_draw",a.add(i,[0,0,1])),c(e,"wedit:selection_draw",a.add(i,[1,0,1])),c(e,"wedit:selection_draw",a.add(i,[0,1,1])),c(e,"wedit:selection_draw",a.add(i,[1,1,1]))}}f.register(z,"draw_line","wedit:draw_line");class G extends _{constructor(){super(...arguments);this.permission="worldedit.region.curve";this.paths=new Map;this.useOn=this.commonUse;this.use=this.commonUse}*commonUse(e,t,r){if(this.baseUse(e,t,r))return;this.paths.has(t)||this.paths.set(t,[]);const o=this.paths.get(t),s=this.traceForPos(e);if(!o.length||!a.equals(o[o.length-1],s)){o.push(s);return}o.unshift(this.getFirstPos(t)),this.clearFirstPos(t),this.paths.delete(t);const i=e.dimension,n=t.history,l=n.record();let h;try{const d=yield*T(o),[u,P]=U(d),p=t.globalPattern.withContext(t,[u,P]),g=t.globalMask.withContext(t);yield*n.trackRegion(l,u,P),h=0;for(const S of d){const x=i.getBlock(S)??(yield*k.loadBlock(S));g.matchesBlock(x)&&p.setBlock(x)&&h++,yield}yield*n.commit(l)}catch(d){throw n.cancel(l),d}b(y.translate("commands.blocks.wedit:created").with(`${h}`),e,!0)}tick(e,t){if(this.baseTick(e,t))return;this.paths.has(t)&&!this.getFirstPos(t)&&this.paths.delete(t);const r=this.paths.get(t)?.slice()??[],o=this.traceForPos(e);(!r.length||!a.equals(r[r.length-1],o))&&r.push(o),r.unshift(this.getFirstPos(t));for(const s of T(r))c(e,"wedit:selection_draw",s),c(e,"wedit:selection_draw",a.add(s,[1,0,0])),c(e,"wedit:selection_draw",a.add(s,[0,1,0])),c(e,"wedit:selection_draw",a.add(s,[1,1,0])),c(e,"wedit:selection_draw",a.add(s,[0,0,1])),c(e,"wedit:selection_draw",a.add(s,[1,0,1])),c(e,"wedit:selection_draw",a.add(s,[0,1,1])),c(e,"wedit:selection_draw",a.add(s,[1,1,1]))}}f.register(G,"draw_curve","wedit:draw_curve");class L extends _{constructor(){super(...arguments);this.permission="worldedit.generation.sphere";this.useOn=this.commonUse;this.use=this.commonUse}*commonUse(e,t,r){if(this.baseUse(e,t,r))return;const o=this.getFirstPos(t),s=Math.floor(this.traceForPos(e).sub(o).length),i=new v(s),n=t.globalPattern.withContext(t,i.getRegion(o));this.clearFirstPos(t);const l=yield*k.run(t,2,i.generate(o,n,null,t));b(y.translate("commands.blocks.wedit:created").with(`${l}`),e,!0)}tick(e,t){if(this.baseTick(e,t))return;const r=this.getFirstPos(t),o=Math.floor(r.sub(this.traceForPos(e)).length)+.5,s=[[new a(0,1,0),"x"],[new a(1,0,0),"y"],[new a(0,1,0),"z"]],i=$(Math.min(o*2*Math.PI,36),4);for(const[n,l]of s)for(let h=0;h<i;h++){let d=n.rotate(h/i*360,l);d=d.mul(o).add(r).add(.5),c(e,"wedit:selection_draw",d)}}}f.register(L,"draw_sphere","wedit:draw_sphere");class q extends _{constructor(){super(...arguments);this.permission="worldedit.generation.cyl";this.useOn=this.commonUse;this.use=this.commonUse}*commonUse(e,t,r){if(this.baseUse(e,t,r))return;const[o,s]=this.getShape(e,t),i=t.globalPattern.withContext(t,o.getRegion(s));this.clearFirstPos(t);const n=yield*k.run(t,2,o.generate(s,i,null,t));b(y.translate("commands.blocks.wedit:created").with(`${n}`),e,!0)}tick(e,t){if(this.baseTick(e,t))return;const[r,o]=this.getShape(e,t);r.draw(e,o)}getShape(e,t){const r=this.getFirstPos(t).clone(),o=this.traceForPos(e),s=Math.floor(o.sub(r).mul([1,0,1]).length);let i=o.y-r.y+1;return i<1&&(r.y+=i,i=-i+1),[new D(i*2,s),r]}}f.register(q,"draw_cylinder","wedit:draw_cylinder");class E extends _{constructor(){super(...arguments);this.permission="worldedit.generation.pyramid";this.useOn=this.commonUse;this.use=this.commonUse}*commonUse(e,t,r){if(this.baseUse(e,t,r))return;const[o,s]=this.getShape(e,t),i=t.globalPattern.withContext(t,o.getRegion(s));this.clearFirstPos(t);const n=yield*k.run(t,2,o.generate(s,i,null,t));b(y.translate("commands.blocks.wedit:created").with(`${n}`),e,!0)}tick(e,t){if(this.baseTick(e,t))return;const[r,o]=this.getShape(e,t);r.draw(e,o)}getShape(e,t){const r=this.getFirstPos(t).clone(),o=this.traceForPos(e),s=Math.max(...o.sub(r).toArray().map((i,n)=>n!==1?Math.abs(i):i))+1;return[new O(s),r]}}f.register(E,"draw_pyramid","wedit:draw_pyramid");class H extends M{constructor(){super(...arguments);this.permission="worldedit.generation.shape"}use(e){F.player.isSneaking(e)?F.uiForms.show("$selectGenMode",e):R.show("$loftManager",e)}}f.register(H,"draw_loft","wedit:draw_loft");
