import{Server as l,RawText as b,removeTickingArea as u,setTickingAreaCircle as p,getCurrentThread as d,regionCenter as f,sleep as g,whenReady as h}from"library/Minecraft.js";import{system as m}from"@minecraft/server";import{getSession as k}from"server/sessions";import{UnloadedChunksError as A}from"./assert";let T=0;class y{constructor(){this.jobs=new Map;this.occupiedTickingAreaSlots=[!1];l.on("tick",()=>{this.manageTickingAreaSlots(),this.printJobs()});for(let t=0;t<9;t++)h(()=>u("wedit:ticking_area_"+t))}*run(t,e,n){const i=++T,r={stepCount:e,step:-1,player:t.player,message:"",percent:0,dimension:t.player.dimension,thread:d()};this.jobs.set(i,r);const a="next"in n?n:n();let s,c;for(;!s?.done;){try{this.current=i,s=a.next(c),this.current=void 0,c=void 0;const o=s.value;o?.jobFunc==="setProgress"?r.percent=Math.min(o.data,1):o?.jobFunc==="nextStep"?(r.message=o.data,r.percent=0,r.step++):s.value instanceof Promise&&(c=yield s.value)}catch(o){throw this.finishJob(i),o}yield}return this.finishJob(i),s.value}nextStep(t){if(this.current)return{jobFunc:"nextStep",data:t}}setProgress(t){if(this.current)return{jobFunc:"setProgress",data:t}}*loadBlock(t,e=this.current){const n=this.jobs.get(e);for(;;){if(!J.isContextValid(e))return;const i=n.dimension.getBlock(t);if(i)return i;if(n.tickingAreaSlot===void 0){n.tickingAreaRequestTime||(n.tickingAreaRequestTime=Date.now()),yield g(1);continue}if(p(t,4,n.dimension,"wedit:ticking_area_"+n.tickingAreaSlot))yield g(1);else throw new A("worldedit.error.tickArea")}}*loadArea(t,e,n){return!!(yield*this.loadBlock(f(t,e),n))}inContext(){return!!this.current}getContext(){return this.current}isContextValid(t){return this.jobs.has(t)}getRunner(t){return this.jobs.get(t??this.getContext()).player}getJobsForSession(t){const e=[],n=t.player;for(const[i,r]of this.jobs.entries())r.player===n&&e.push(i);return e}cancelJob(t){const e=this.jobs.get(t),n=k(e.player).history;for(const i of n.getActivePointsInThread(e.thread))n.cancel(i);e.thread.abort(),this.finishJob(t)}finishJob(t){if(this.jobs.has(t)){const e=this.jobs.get(t);e.percent=1,e.step=e.stepCount-1,e.message?.length&&(e.message="Finished!"),e.tickingAreaSlot!==void 0&&(u("wedit:ticking_area_"+e.tickingAreaSlot,e.dimension),this.occupiedTickingAreaSlots[e.tickingAreaSlot]=!1),this.printJobs(),this.jobs.delete(t)}}printJobs(){const t=new Map;for(const e of this.jobs.values())if(e.message?.length){t.has(e.player)||t.set(e.player,[]);const n=(e.percent+e.step)/e.stepCount;t.get(e.player).push([e.tickingAreaRequestTime?"Loading Chunks...":e.message,n])}for(const[e,n]of t.entries()){let i,r=0;for(const[a,s]of n){i&&i.append("text",`
`);let c="";if(s>=0)for(let o=0;o<20;o++)c+=o/20<=s?"\u2588":"\u2592";else for(let o=0;o<20;o++)c+=(o-2*m.currentTick)%20>-5?"\u2588":"\u2592";i||(i=new b),n.length>1&&i.append("text",`Job ${++r}: `),i.append("translate",a).append("text",`
${c} ${s>=0?(s*100).toFixed(2):". . . ."}%`)}l.queueCommand(`titleraw @s actionbar ${i.toString()}`,e)}}manageTickingAreaSlots(){const t=Array.from(this.jobs.values()),e=t.filter(i=>i.tickingAreaRequestTime).sort((i,r)=>i.tickingAreaRequestTime-r.tickingAreaRequestTime);if(!e)return;const n=t.filter(i=>i.tickingAreaUsageTime&&i.tickingAreaUsageTime<Date.now()-2e3).sort((i,r)=>i.tickingAreaUsageTime-r.tickingAreaUsageTime);for(const i of e){let r=this.occupiedTickingAreaSlots.findIndex(a=>!a);if(r===-1&&n.length){const a=n.shift();r=a.tickingAreaSlot,a.tickingAreaSlot=void 0,a.tickingAreaRequestTime=void 0,a.tickingAreaUsageTime=void 0}r!==-1&&(i.tickingAreaRequestTime=void 0,i.tickingAreaUsageTime=Date.now(),i.tickingAreaSlot=r,this.occupiedTickingAreaSlots[r]=!0)}}}const J=new y;export{J as Jobs};
