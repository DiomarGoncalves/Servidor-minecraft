import{BlockPermutation as N}from"@minecraft/server";import{Vector as m,Server as C,whenReady as V}from"library/Minecraft.js";import{wrap as w}from"server/util.js";import{Token as D}from"./extern/tokenizr.js";import{tokenize as A,throwTokenError as d,mergeTokens as R,parseBlock as z,parseBlockStates as U,processOps as x,parseNumberList as I,blockPermutation2ParsedBlock as E,parsedBlock2BlockPermutation as O}from"./block_parsing.js";import{Cardinal as S}from"./directions.js";class v{constructor(n=""){this.stringObj="";this.context={};n&&V(()=>{const s=v.parseArgs([n]).result;this.block=s.block,this.stringObj=s.stringObj})}withContext(n,s){const e=this.clone();e.context.session=n,e.context.range=[m.from(s[0]),m.from(s[1])],e.context.cardinal=new S(S.Dir.FORWARD),e.context.placePosition=n.getPlacementPosition();try{const t=C.player.getHeldItem(n.player);e.context.hand=C.block.itemToPermutation(t)}catch{e.context.hand=N.resolve("minecraft:air")}return e}setBlock(n){try{const s=n.permutation,e=this.block.getPermutation(n,this.context);return e?(n.setPermutation(e),!s.matches(n.typeId)):!1}catch{return!1}}getRootNode(){return this.block}clear(){this.block=null,this.stringObj="",this.simpleCache=void 0}empty(){return this.block==null}addBlock(n){if(!this.block)this.block=new y(null);else if(!(this.block instanceof y)){const e=this.block;this.block=new y(null),this.block.nodes.push(e)}const s=E(n);this.block.nodes.push(new B(null,s)),this.stringObj&&(this.stringObj+=","),this.stringObj+=s.id.replace("minecraft:",""),s.states.size&&(this.stringObj+=`[${[...s.states].map(([e,t])=>`${e}=${t}`).join(",")}]`),this.simpleCache=void 0}getBlockSummary(){let n="";const s=new Map;for(const t of this.block.nodes){let o=t.block.id.replace("minecraft:","");for(const r of t.block.states){const i=r[1];if(typeof i=="string"&&i!="x"&&i!="y"&&i!="z"){o+=`(${i})`;break}}s.has(o)?s.set(o,s.get(o)+1):s.set(o,1)}let e=0;for(const t of s)t[1]>1?n+=`${t[1]}x ${t[0]}`:n+=t[0],e<s.size-1&&(n+=", "),e++;return n}toJSON(){return this.stringObj}isSimple(){return this.block instanceof B||this.block instanceof y&&this.block.nodes.length==1&&this.block.nodes[0]instanceof B}fillBlocks(n,s,e){const t=e?.getSimpleBlockFilter();if(this.isSimple())return this.simpleCache||(this.block instanceof B?this.simpleCache=O(this.block.block):this.block instanceof y&&(this.simpleCache=O(this.block.nodes[0].block))),n.fillBlocks(s,this.simpleCache,{blockFilter:t}).getCapacity();{let o=0;s=n.getBlocks(s,t);for(const r of s.getBlockLocationIterator())o+=this.setBlock(n.getBlock(r))?1:0;return o}}clone(){const n=new v;return n.block=this.block,n.stringObj=this.stringObj,n}toString(){return`[pattern: ${this.stringObj}]`}static parseArgs(n,s=0){const e=n[s];if(!e)return{result:new v,argIndex:s+1};const t=A(e);let o;function r(c){const h=[],l=[],P=t.curr();function u(){return R(o,t.curr(),e)}for(;o=t.next();)if(o.value==="void")l.push(new $(u()));else if(o.type=="id")l.push(new B(u(),z(t,e,!1)));else if(o.type=="number"){const a=o,f=t.next();f.value=="%"?x(l,h,new j(u(),a.value)):d(f)}else if(o.value==",")x(l,h,new y(o));else if(o.value=="^"){const a=t.next();a.type=="id"?l.push(new L(u(),z(t,e,!0))):a.value=="["?l.push(new W(u(),U(t))):d(a)}else if(o.value=="*"){const a=t.next();a.type!="id"&&d(a),l.push(new J(u(),z(t,e,!0)))}else if(o.value=="$"){const a=t.next();let f;if(a.type!="id"&&d(a),t.peek().value=="."){t.next();const b=t.next()?.value;f=b==="rad"?"radial":b==="lit"?"light":S.parseArgs([b]).result}l.push(new M(u(),a.value,f))}else if(o.value=="#"){const a=t.next();if(a.value=="clipboard"){let f=m.ZERO;if(t.peek()?.value=="@"){t.next(),t.next().value!="["&&d(t.curr());const b=I(t,3);f=m.from(b)}l.push(new F(u(),f.floor()))}else a.value=="hand"?l.push(new Z(u())):a.value.match?.(/blob[1-9][0-9]*/)?(t.peek()?.value!="("&&d(t.peek()),x(l,h,new G(u(),Number.parseInt(a.value.slice(4))))):d(a)}else if(o.type=="bracket")if(o.value=="(")l.push(r(!0));else if(o.value==")")if(!c)d(o);else{x(l,h);break}else d(o);else o.type=="EOF"?c?d(o):x(l,h):d(o);if(l.length>1)d(l.slice(-1)[0].token);else if(!l.length)d(P);else if(h.length){const a=h.slice(-1)[0];d(a instanceof D?a:a.token)}return l[0]}let i;try{i=r(!1),i.postProcess()}catch(c){throw c.pos!=null?{isSyntaxError:!0,idx:s,start:c.pos,end:c.pos+1,stack:c.stack}:c}const p=new v;return p.stringObj=n[s],p.block=i,{result:p,argIndex:s+1}}}class g{constructor(n){this.token=n;this.nodes=[]}postProcess(){}toJSON(){return{type:this.constructor.name,nodes:this.nodes.map(n=>n.toJSON())}}}class B extends g{constructor(s,e){super(s);this.block=e;this.prec=-1;this.opCount=0;this.permutation=O(e)}getPermutation(){return this.permutation}}class $ extends g{constructor(){super(...arguments);this.prec=-1;this.opCount=0}getPermutation(){}}class L extends g{constructor(s,e){super(s);this.type=e;this.prec=-1;this.opCount=0;this.permutation=N.resolve(e),this.props=this.permutation.getAllStates()}getPermutation(s){let e=this.permutation;return Object.entries(s.permutation.getAllStates()).forEach(([t,o])=>{t in this.props&&(e=e.withState(t,o))}),e}}class W extends g{constructor(s,e){super(s);this.states=e;this.prec=-1;this.opCount=0}getPermutation(s){let e=s.permutation;const t=e.getAllStates();return this.states.forEach((o,r)=>{r in t&&(e=e.withState(r,o))}),e}}class J extends g{constructor(s,e){super(s);this.block=e;this.prec=-1;this.opCount=0;this.permutations=Array.from(C.block.iteratePermutations(this.block))}getPermutation(){return this.permutations[Math.floor(Math.random()*this.permutations.length)]}}class F extends g{constructor(s,e){super(s);this.offset=e;this.prec=-1;this.opCount=0}getPermutation(s,e){const t=e.session?.clipboard,o=t.getSize(),r=m.sub(s.location,this.offset),i=new m(w(r.x,o.x),w(r.y,o.y),w(r.z,o.z));return t.getBlock(i).permutation}}class Z extends g{constructor(s){super(s);this.prec=-1;this.opCount=0}getPermutation(s,e){return e.hand}}class M extends g{constructor(s,e,t){super(s);this.gradientId=e;this.cardinal=t;this.prec=-1;this.opCount=0;this.radial=!1;this.radialOrigin="center";const o=t==="radial"||t==="light";t&&!o&&this.updateDirectionParams(t),o&&(this.radial=!0,t==="light"&&(this.radialOrigin="placement"))}getPermutation(s,e){const t=e.session.getGradient(this.gradientId);if(t){const o=t.patterns.length;let r=0;if(this.radial){let i=e.range[0].lerp(e.range[1],.5),p;if(this.radialOrigin==="center")p=e.range[1].distanceTo(e.range[0])/2;else{const c=e.placePosition,h=e.range[1],l=e.range[0],P=c.x<i.x?h.x:l.x,u=c.y<i.y?h.y:l.y,a=c.z<i.z?h.z:l.z;p=c.distanceTo(new m(P,u,a)),i=c}r=Math.floor(i.distanceTo(s.location)/p*(o-t.dither)+Math.random()*t.dither)}else{!this.cardinal&&this.ctxCardinal!==e.cardinal&&(this.updateDirectionParams(e.cardinal,e.session.player),this.ctxCardinal=e.cardinal);const i=m.sub(s.location,e.range[0]).div(e.range[1].sub(e.range[0]).max([1,1,1])),p=this.invertCoords?1-i[this.axis]:i[this.axis];r=Math.floor(p*(o-t.dither)+Math.random()*t.dither)}return t.patterns[Math.min(Math.max(r,0),o-1)].getRootNode().getPermutation(s,e)}}updateDirectionParams(s,e){const t=s.getDirection(e),o=[Math.abs(t.x),Math.abs(t.y),Math.abs(t.z)];o[0]>o[1]&&o[0]>o[2]?this.axis="x":o[1]>o[0]&&o[1]>o[2]?this.axis="y":this.axis="z",this.invertCoords=t[this.axis]<0}}class j extends g{constructor(s,e){super(s);this.percent=e;this.prec=2;this.opCount=1}getPermutation(){return null}}class G extends g{constructor(s,e){super(s);this.size=e;this.prec=-1;this.opCount=1;this.offsets=[];this.perms={};this.ranges={};this.points={};this.isRadial=!1;this.offsets=[];for(let t=-1;t<=1;t++)for(let o=-1;o<=1;o++)for(let r=-1;r<=1;r++)this.offsets.push(new m(r*this.size,o*this.size,t*this.size))}postProcess(){this.nodes[0].postProcess(),this.isRadial=this.nodes[0]instanceof M&&this.nodes[0].cardinal==="radial",this.perms={},this.ranges={},this.points={}}getPermutation(s,e){const t=this.size,o=m.from(s.location),r=o.div(t).floor().mul(t);let i=0,p=1/0;for(const c of this.offsets){const h=r.x+c.x,l=r.y+c.y,P=r.z+c.z,u=Math.floor(Math.floor(h/t)*4576.498+Math.floor(l/t)*76392.953+Math.floor(P/t)*203478.295)%1024;if(!this.points[u]){const b=new m(this.randomNum(),this.randomNum(),this.randomNum());if(this.points[u]=b,this.isRadial){const T=b.offset(h,l,P);this.ranges[u]={range:[T.offset(-this.size,-this.size,-this.size),T.offset(this.size,this.size,this.size)]}}}const a=this.points[u],f=Math.hypot(h+a.x-o.x,l+a.y-o.y,P+a.z-o.z);f<p&&(i=u,p=f)}return this.isRadial?this.nodes[0].getPermutation(s,{...e,...this.ranges[i]}):(i in this.perms||(this.perms[i]=this.nodes[0].getPermutation(s,e)),this.perms[i])}randomNum(){return Math.random()*(this.size-1)}}class y extends g{constructor(){super(...arguments);this.prec=1;this.opCount=2;this.evenDistribution=!0;this.cumWeights=[]}getPermutation(s,e){if(this.nodes.length==1)return this.nodes[0].getPermutation(s,e);if(this.evenDistribution)return this.nodes[Math.floor(Math.random()*this.nodes.length)].getPermutation(s,e);{const t=Math.random()*this.weightTotal;for(let o=0;o<this.nodes.length;o++)if(this.cumWeights[o]>=t)return this.nodes[o].getPermutation(s,e)}}postProcess(){super.postProcess();const s=100/this.nodes.length;let e=0;const t=this.nodes,o=[];for(this.nodes=[];t.length;){const r=t.shift();if(r instanceof y){const i=r.nodes.reverse();for(const p of i)t.unshift(p)}else r instanceof j?(this.evenDistribution=!1,this.nodes.push(r.nodes[0]),o.push(r.percent),r.nodes[0].postProcess(),e+=r.percent):(this.nodes.push(r),o.push(s),r.postProcess(),e+=s)}if(o.map(r=>r/e),!this.evenDistribution){for(let r=0;r<o.length;r+=1)this.cumWeights.push(o[r]+(this.cumWeights[r-1]||0));this.weightTotal=this.cumWeights[this.cumWeights.length-1]}}}export{v as Pattern};
