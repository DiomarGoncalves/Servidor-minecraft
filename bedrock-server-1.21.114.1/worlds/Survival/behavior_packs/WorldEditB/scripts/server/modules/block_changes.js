import{BlockPermutation as a}from"@minecraft/server";import{Vector as s,iterateChunk as c,whenReady as h}from"library/Minecraft.js";let o;h(()=>o=a.resolve("minecraft:air"));function C(n,t){return new m(n.player.dimension,n.history,t)}class m{constructor(t,e,i){this.blockCache=new Map;this.iteration=new Map;this.changes=new Map;this.ranges=[];this.dimension=t,this.history=e,this.record=i}getBlockPerm(t){const e=this.vec2string(t),i=this.changes.get(e);try{return i||(this.blockCache.has(e)||this.blockCache.set(e,this.dimension.getBlock(t)),this.blockCache.get(e).permutation??o)}catch{return o}}getBlock(t){const e=this.getBlockPerm(t);return{x:t.x,y:t.y,z:t.z,typeId:e.type.id,permutation:e,location:t,dimension:this.dimension,setPermutation:i=>this.setBlock(t,i),hasTag:e.hasTag,get isAir(){return e.type.id=="minecraft:air"}}}setBlock(t,e){if(this.iteration.set(this.vec2string(t),e),!this.ranges.length)this.ranges.push([s.from(t),s.from(t)]);else{const[i,r]=this.ranges[0];i.x=Math.min(i.x,t.x),i.y=Math.min(i.y,t.y),i.z=Math.min(i.z,t.z),r.x=Math.max(r.x,t.x),r.y=Math.max(r.y,t.y),r.z=Math.max(r.z,t.z)}}applyIteration(){this.iteration.size&&(this.changes=new Map([...this.changes,...this.iteration]),this.iteration.clear())}getRegion(){return this.ranges.map(t=>[t[0],t[1]])}*flush(){this.applyIteration();for(const e of this.ranges)yield*this.history.trackRegion(this.record,...e);let t=0;for(const[e,i]of this.changes.entries()){try{this.blockCache.get(e).setPermutation(i)}catch{}t++,c&&(yield t)}this.ranges.length=0,this.changes.clear()}vec2string(t){return""+t.x+"_"+t.y+"_"+t.z}}export{C as recordBlockChanges};
