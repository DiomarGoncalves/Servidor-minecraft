import{ItemStack as h,ItemLockMode as u}from"@minecraft/server";import{Server as f,contentLog as g,Vector as c}from"library/Minecraft.js";import l from"config.js";import{getViewVector as y,getWorldHeightLimits as I}from"server/util.js";import{getSession as w,hasSession as v}from"server/sessions.js";class C{constructor(){f.on("playerChangeDimension",t=>{g.debug(`"${t.player.name}" has travelled to "${t.dimension.id}"`);const e="wedit:stasher_for_"+t.player.name;f.runCommand(`tp @e[name="${e}"] ~ 512 ~`,t.player)})}hasItem(t,e){let n=f.player.getItemCount(t,e).length!=0;if(this.isHotbarStashed(t)&&!n){let r;for(const o of t.dimension.getEntities({name:"wedit:stasher_for_"+t.name}))r=o;if(r){const o=r.getComponent("inventory").container;for(let i=0;i<9;i++){const m=o.getItem(i);if(m&&m.typeId==e){n=!0;break}}}}return n}replaceItem(t,e,n,r=!1){const o=t.getComponent("inventory").container;for(let i=0;i<o.size;i++)if(o.getItem(i)?.typeId===e){const m=new h(n,o.getItem(i).amount);r&&(m.lockMode=u.slot),o.setItem(i,m);break}}getBlockLocation(t){return new c(Math.floor(t.location.x),Math.floor(t.location.y),Math.floor(t.location.z))}traceForBlock(t,e,n){n&&v(t.id)&&(n=n?.withContext(w(t)));const r=t.getHeadLocation(),o=y(t),i=t.dimension;if(!n||n.empty()){const a=Math.min(e??l.traceDistance,l.traceDistance);let s=t.getBlockFromViewDirection({includePassableBlocks:!1,includeLiquidBlocks:!1,maxDistance:a*2});return s&&c.from(s.block).distanceTo(t.getHeadLocation())>a&&(s=void 0),!s&&typeof e!="number"?void 0:s?c.from(s.block):c.mul(t.getViewDirection(),e).add(t.getHeadLocation()).floor()}let m=new c(1/0,1/0,1/0);for(let a=0;a<l.traceDistance;a+=.2){const s=new c(Math.floor(r.x+o.x*a),Math.floor(r.y+o.y*a),Math.floor(r.z+o.z*a));if(!m.equals(s)){m=s;try{const d=i.getBlock(s);if(d){if(n&&n.matchesBlock(d))return s;if(!n&&!d.isAir)return s;if(e&&e>0&&a>=e)return s}else continue}catch{}}}}isHotbarStashed(t){return Array.from(t.dimension.getEntities({name:`wedit:stasher_for_${t.name}`})).length!=0}stashHotbar(t){if(this.isHotbarStashed(t))return!0;const e=t.dimension.spawnEntity("wedit:inventory_stasher",new c(t.location.x,I(t.dimension)[1],t.location.z));e.nameTag="wedit:stasher_for_"+t.name;const n=t.getComponent("inventory").container,r=e.getComponent("inventory").container;for(let o=0;o<9;o++)n.getItem(o)&&n.swapItems(o,o,r);return!1}restoreHotbar(t){let e;const n="wedit:stasher_for_"+t.name;f.runCommand(`tp @e[name="${n}"] ~ 512 ~`,t),f.runCommand(`tp @e[name="${n}"] ~ 512 ~`,t);for(const r of t.dimension.getEntities({name:n}))e=r;if(e){const r=t.getComponent("inventory").container,o=e.getComponent("inventory").container;for(let i=0;i<9;i++)r.swapItems(i,i,o);return f.runCommand(`tp @e[name="${n}"] ~ ~ ~`,t),e.triggerEvent("wedit:despawn"),e.nameTag="despawned",!1}else return!0}}const B=new C;export{B as PlayerUtil};
