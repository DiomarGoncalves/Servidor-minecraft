import{contentLog as w}from"library/Minecraft.js";import{Token as T}from"./extern/tokenizr.js";import{tokenize as A,throwTokenError as c,mergeTokens as E,processOps as u}from"./block_parsing.js";class p{constructor(t=""){this.stringObj="";if(t){const e=p.parseArgs([t]).result;this.stringObj=e.stringObj}}compile(t=["x","y","z"]){return w.debug(this.root.compile()),new Function(...t,"return "+this.root.compile())}clone(){const t=new p;return t.root=this.root,t.stringObj=this.stringObj,t}toString(){return`[expression: ${this.stringObj}]`}toJSON(){return this.stringObj}static parseArgs(t,e=0){const l=t[e];if(!l)return{result:new p,argIndex:e+1};const r=A(l);let s;function g(n=null){const i=[],o=[],k=r.curr();function y(){return E(s,r.curr(),l)}for(;s=r.next();)if(s.type!="space")if(s.type=="number")o.push(new O(s));else if(s.type=="id")if(r.peek().value==="("){r.next();const a=[],x=s;for(;r.curr().value==="("||r.curr().value===",";)a.push(g("functionArg"));s=x;const v=new C(y(),s.value);v.nodes=a,o.push(v)}else o.push(new j(s));else if(["+","-","*","/","^","%","=","!","~",">","<"].includes(s.value)&&r.peek().value==="=")r.next(),u(o,i,new f(y()));else if([">","<","&","|"].includes(s.value))r.peek().value===s.value?(r.next(),u(o,i,new f(y()))):s.value===">"||s.value==="<"?u(o,i,new f(s)):c(s);else if(["+","-","*","/","^","%"].includes(s.value))u(o,i,new f(s));else if(s.value==="(")o.push(g("bracket"));else if(s.value===")")if(n!="bracket"&&n!="functionArg")c(s);else{u(o,i);break}else if(s.value===",")if(n!="functionArg")c(s);else{u(o,i);break}else s.type=="EOF"?n?c(s):u(o,i):c(s);if(o.length>1)c(o.slice(-1)[0].token);else if(!o.length)c(k);else if(i.length){const a=i.slice(-1)[0];c(a instanceof T?a:a.token)}return o[0]}let m;try{m=g(),m.postProcess()}catch(n){throw n.pos!=null?{isSyntaxError:!0,idx:e,start:n.pos,end:n.pos+1,stack:n.stack}:n}const b=new p;return b.stringObj=t[e],b.root=m,{result:b,argIndex:e+1}}}class h{constructor(t){this.token=t;this.nodes=[]}postProcess(){}}class O extends h{constructor(e){super(e);this.prec=-1;this.opCount=0;this.value=e.value}compile(){return this.value.toString()}}class j extends h{constructor(e){super(e);this.prec=-1;this.opCount=0;this.id=e.value}compile(){return this.id}postProcess(){this.id.toLowerCase()=="pi"?this.id=Math.PI.toString():this.id.toLowerCase()=="e"&&(this.id=Math.E.toString())}}class C extends h{constructor(e,l){super(e);this.prec=-1;this.opCount=0;this.id=l}compile(){let e=this.id+"(",l=!1;for(const r of this.nodes)e+=(l?",":"")+r.compile(),l=!0;return e+")"}postProcess(){this.id=="ln"&&(this.id="log"),["abs","acos","asin","atan2","atan","cbrt","ceil","cos","cosh","exp","floor","log","max","min","round","sin","sinh","sqrt","tan","tanh"].includes(this.id)&&(this.id="Math."+this.id);for(const e of this.nodes)e.postProcess()}}class f extends h{constructor(e){super(e);this.opCount=2;this.ops={"=":1,"+=":1,"-=":1,"*=":1,"/=":1,"%=":1,"^=":1,"&&":2,"||":2,"==":3,"!=":3,"~=":3,"<":4,"<=":4,">":4,">=":4,"<<":5,">>":5,"+":6,"-":6,"*":7,"/":7,"%":7,"^":8};this.opType=e.value,this.prec=this.ops[e.value],this.rightAssoc=["=","+=","-=","*=","/=","%=","^=","^"].includes(e.value)}postProcess(){for(const e of this.nodes)e.postProcess()}compile(){if(this.opType.startsWith("^")){const e=`Math.pow(${this.nodes[0].compile()},${this.nodes[1].compile()})`;return this.opType.endsWith("=")?this.nodes[0].compile()+"="+e:e}else return`(${this.nodes[0].compile()}${this.opType}${this.nodes[1].compile()})`}}export{p as Expression};
