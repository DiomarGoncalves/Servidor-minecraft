import{contentLog as m,RawText as d,Server as h}from"library/Minecraft.js";import{BlockPermutation as b,BlockStates as x}from"@minecraft/server";import{Token as g,Tokenizr as y,ParsingError as T}from"./extern/tokenizr.js";const c=new y;c.rule(/[~#%^=*+-/|:!&,@$\.]/,e=>{e.accept("misc")}),c.rule(/\s+/,e=>{e.accept("space")}),c.rule(/[\[\]\(\)\<\>\{\}]/,e=>{e.accept("bracket")}),c.rule(/(true|false)/,(e,t)=>{e.accept("boolean",t[0]=="true")}),c.rule(/[a-zA-Z_][a-zA-Z0-9_]*/,e=>{e.accept("id")}),c.rule(/-?[0-9]+(\.[0-9]+)*/,(e,t)=>{e.accept("number",parseFloat(t[0]))}),c.rule(/-?[0-9]+/,(e,t)=>{e.accept("number",parseInt(t[0]))});function z(e){try{c.input(e)}catch(t){throw t instanceof T?{isSyntaxError:!0,idx:-1,start:t.pos,end:t.pos+1,stack:m.stack()}:t}return new B(c.tokens())}function w(e,t,s){const r=s.substring(e.pos,t.pos+t.text.length);return new g("merge",r,r,e.pos)}function i(e){throw{isSyntaxError:!0,idx:-1,start:e.pos,end:e.pos+e.text.length-1,stack:m.stack()}}function V(e,t,s){for(;t.length;){const r=t.slice(-1)[0];if(s&&(s.prec>r.prec||s.prec==r.prec&&r.rightAssoc))break;e.length<r.opCount&&i(r.token),t.pop();for(let o=0;o<r.opCount;o++)r.nodes.unshift(e.pop());e.push(r)}s&&t.push(s)}function D(e){const t=new Map;return Object.entries(e.getAllStates()).forEach(([s,r])=>{!s.startsWith("wall_connection_type")&&!s.startsWith("liquid_depth")&&t.set(s,r)}),{id:e.type.id,states:t}}function M(e){return b.resolve(e.id,Object.fromEntries(e.states?.entries()??[]))}function $(e){let t=e.id;t.startsWith("minecraft:")&&(t=t.slice(10));const s=e.states;return s?.size&&(t+=`[${Array.from(s.entries()).map(([r,o])=>(o=typeof o=="string"?`"${o}"`:o,`"${r}"=${o}`)).join(",")}]`),t}function j(e,t,s,r=!1){let o=e.curr();const a={id:e.curr().value,states:null};let n;function u(){a.id.includes(":")||(a.id="minecraft:"+a.id);let l,f;try{l=b.resolve(a.id),f=l.getAllStates()}catch{i(o)}!r&&l.getState("persistent_bit")!=null&&!a.states?.has("persistent_bit")&&(a.states||(a.states=new Map),a.states.set("persistent_bit",!0));for(const[p,k]of a.states?.entries()??[])if(p in f){if(typeof k!=typeof f[p])throw d.translate("commands.blockstate.typeError").with(p);if(!x.get(p).validValues.includes(k))throw d.translate("commands.blockstate.valueError").with(p)}else throw d.translate("commands.blockstate.stateError").with(p).with(a.id);return s?a.id:a}for(;n=e.peek();)switch(n.type){case"misc":if(n.value==":"){n=e.next();const l=e.peek();if(l.type=="id"){if((a.id.includes(":")||a.states)&&i(l),a.id+=":"+l.value,n=e.next(),o=w(o,n,t),s)return u()}else{if(l.type=="number")return s||(a.states&&i(l),a.states=new Map(Object.entries(h.block.dataValueToStates(a.id,l.value))),n=e.next()),u();i(l)}}else return u();break;case"bracket":return n.value=="["&&(s||(a.states!=null&&i(n),n=e.next(),a.states=v(e))),u();default:return u()}}function v(e){const t=new Map;let s=!1,r=null,o=null;function a(){t.set(r,o),s=!1,r=null,o=null}let n;for(;n=e.next();)switch(n.type){case"id":case"number":case"boolean":s?(o!=null&&i(n),o=n.value):((r!=null||n.type=="number"||n.type=="boolean")&&i(n),r=n.value);break;case"misc":n.value==":"?(n=e.next(),(n.type!="id"||r==null||r.includes(":")||s)&&i(n),r+=":"+n.value):n.value=="="?(s&&i(n),s=!0):n.value==","?(o==null&&i(n),a()):i(n);break;case"bracket":return(n.value!="]"||n.value=="]"&&o==null)&&i(n),a(),t;default:i(n)}}function C(e,t){const s=[];let r,o;for(;r=e.next();)if(r.type=="number")o&&i(r),o=r;else if(r.value==",")(!o||s.length==t-1)&&i(r),s.push(o.value),o=null;else if(r.value=="]"){(!o||s.length!=t-1)&&i(r),s.push(o.value);break}else i(r);return s}class B{constructor(t){this.tokens=t;this.idx=-1}curr(){return this.currToken}next(){return this.currToken=this.tokens[++this.idx],this.currToken}peek(t=0){return this.tokens[this.idx+t+1]}seek(t){return this.idx=t-1,this.next()}getPos(){return this.idx}}export{D as blockPermutation2ParsedBlock,w as mergeTokens,j as parseBlock,v as parseBlockStates,C as parseNumberList,M as parsedBlock2BlockPermutation,$ as parsedBlock2CommandArg,V as processOps,i as throwTokenError,z as tokenize};
