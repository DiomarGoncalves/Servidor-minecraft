import{Jobs as d}from"server/modules/jobs.js";import{RawText as D,Vector as a}from"library/Minecraft.js";import{getWorldHeightLimits as O}from"../../util.js";import{CylinderShape as z}from"../../shapes/cylinder.js";import{registerCommand as P}from"../register_commands.js";const S={name:"snow",permission:"worldedit.utility.snow",description:"commands.wedit:snow.description",usage:[{flag:"s"},{name:"size",type:"int",range:[1,null]},{name:"height",type:"int",range:[1,null],default:-1}]};function W(m){const l={includeLiquidBlocks:!1,includePassableBlocks:!1,maxDistance:1},n=m.dimension,c=a.from(m.location).add([.5,1.99,.5]);let o=!!n.getBlockFromRay(c,a.DOWN,l);return o&&o&&(o=!!n.getBlockFromRay(c.add([-.49,0,0]),a.DOWN,l)),o&&o&&(o=!!n.getBlockFromRay(c.add([.49,0,0]),a.DOWN,l)),o&&o&&(o=!!n.getBlockFromRay(c.add([0,0,-.49]),a.DOWN,l)),o&&o&&(o=!!n.getBlockFromRay(c.add([0,0,.49]),a.DOWN,l)),o}P(S,function*(m,l,n){const c=l.dimension,o=n.get("size"),p=n.get("height")<0?4096:(n.get("height")-1)*2+1,h=m.getPlacementPosition(),k=new z(p,o),t=k.getRegion(h),w=O(c);return t[0].y=Math.max(t[0].y,w[0]),t[1].y=Math.min(t[1].y,w[1]-1),yield*d.run(m,2,function*(){yield d.nextStep("Raycasting...");let g=0;const f=[],B=[],x=(t[1].x-t[0].x+1)*(t[1].z-t[0].x+1),R={includeLiquidBlocks:!0,includePassableBlocks:!0,maxDistance:p};for(let s=t[0].x;s<=t[1].x;s++)for(let r=t[0].z;r<=t[1].z;r++){if(!k.getYRange(s-h.x,r-h.z)?.map(i=>i+h.y)){g++;continue}const u=new a(s+.5,t[1].y+1.01,r+.5);try{const i=c.getBlockFromRay(u,a.DOWN,R)?.block;i&&(f.push(i),B.push(i.location))}catch{}yield d.setProgress(g/x),g++,yield}yield d.nextStep("Generating blocks...");let y=0;if(g=0,f.length){const s=m.history,r=s.record();try{yield*s.trackRegion(r,B);for(let e of f){const u=e.location;if(e?.isValid||(e=yield*d.loadBlock(u)),e.matches("water"))e.setType("ice"),y++;else if(e.matches("snow_layer")){if(n.has("s")&&Math.random()<.4){let i=e.permutation;const b=i.getState("height");i=i.withState("height",Math.min(b+1,7)),e.setPermutation(i),i.getState("height")!=b&&y++}}else e.matches("ice")||W(e)&&(c.getBlock(a.from(e.location).offset(0,1,0)).setType("snow_layer"),y++);yield d.setProgress(g++/f.length),yield}yield*s.commit(r)}catch(e){throw s.cancel(r),e}}return D.translate("commands.blocks.wedit:changed").with(`${y}`)})});
