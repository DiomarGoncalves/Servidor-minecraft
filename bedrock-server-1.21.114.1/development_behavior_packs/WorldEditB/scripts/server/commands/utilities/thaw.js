import{Jobs as i}from"server/modules/jobs.js";import{RawText as z,Vector as k}from"library/Minecraft.js";import{getWorldHeightLimits as B}from"../../util.js";import{CylinderShape as P}from"../../shapes/cylinder.js";import{registerCommand as C}from"../register_commands.js";const L={name:"thaw",permission:"worldedit.utility.thaw",description:"commands.wedit:thaw.description",usage:[{name:"size",type:"int",range:[1,null]},{name:"height",type:"int",range:[1,null],default:-1}]};C(L,function*(l,b,m){const h=b.dimension,w=m.get("size"),y=m.get("height")<0?4096:(m.get("height")-1)*2+1,s=l.getPlacementPosition(),u=new P(y,w),e=u.getRegion(s),f=B(h);return e[0].y=Math.max(e[0].y,f[0]),e[1].y=Math.min(e[1].y,f[1]-1),yield*i.run(l,2,function*(){yield i.nextStep("Raycasting...");let r=0;const a=[],p=[],x=(e[1].x-e[0].x+1)*(e[1].z-e[0].x+1),R={includeLiquidBlocks:!0,includePassableBlocks:!0,maxDistance:y};for(let o=e[0].x;o<=e[1].x;o++)for(let n=e[0].z;n<=e[1].z;n++){if(!u.getYRange(o-s.x,n-s.z)?.map(c=>c+s.y)){r++;continue}const g=new k(o+.5,e[1].y+1.01,n+.5);try{const c=h.getBlockFromRay(g,k.DOWN,R)?.block;c&&(a.push(c),p.push(c.location))}catch{}yield i.setProgress(r/x),r++}yield i.nextStep("Generating blocks...");let d=0;if(r=0,a.length){const o=l.history,n=o.record();try{yield*o.trackRegion(n,p);for(let t of a){const g=t.location;t?.isValid||(t=yield*i.loadBlock(g)),t.matches("ice")?(t.setType("water"),d++):t.matches("snow_layer")&&(t.setType("air"),d++),yield i.setProgress(r++/a.length)}yield*o.commit(n)}catch(t){throw o.cancel(n),t}}return z.translate("commands.blocks.wedit:changed").with(`${d}`)})});
