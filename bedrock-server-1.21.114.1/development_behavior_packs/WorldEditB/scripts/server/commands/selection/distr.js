import{assertClipboard as y,assertSelection as _}from"server/modules/assert.js";import{Jobs as s}from"server/modules/jobs.js";import{RawText as B}from"library/Minecraft.js";import{BlockPermutation as $}from"@minecraft/server";import{registerCommand as S}from"../register_commands.js";const x={name:"distr",description:"commands.wedit:distr.description",permission:"worldedit.analysis.distr",usage:[{flag:"c"},{flag:"d"}]};S(x,function*(i,u,d){let l;const c=new Map,p=d.has("d");yield*s.run(i,1,function*(){yield s.nextStep("Analysing blocks...");let t=0;const n=r=>{let e=r.type.id;if(p)for(const o of Object.values(r.getAllStates()))e+=`|${o}`;c.set(e,(c.get(e)??0)+1)};if(d.has("c")){y(i),l=i.clipboard.getVolume();const r=i.clipboard;for(const e of r.getBlocks())n(e.permutation),yield s.setProgress(++t/l)}else{_(i),l=i.selection.getBlockCount();const r=u.dimension;yield s.nextStep("Analysing blocks...");for(const e of i.selection.getBlocks()){const o=r.getBlock(e)??(yield*s.loadBlock(e));n(o.permutation),yield s.setProgress(++t/l)}}});const b=Array.from(c.entries()).sort((t,n)=>n[1]-t[1]),g=B.text(`__________
`);for(let[t,n]of b){if(p){let e=1;const o=t.split("|"),a=new Map,k=$.resolve(o[0]);for(const[f,m]of Object.entries(k.getAllStates()))o[e]&&`${m}`!=o[e]&&a.set(f,o[e]),e++;if(t=o[0],a.size){t+="[";for(const[f,m]of a.entries())t+=`${f}=${m},`;t=t.slice(0,-1)+"]"}}const r=(n/l*100).toFixed(3);t.startsWith("minecraft:")&&(t=t.slice(10)),g.append("text",`
${n}${" ".repeat(8-n.toString().length*1.5)} (%${r}) ${t}`)}return g});
