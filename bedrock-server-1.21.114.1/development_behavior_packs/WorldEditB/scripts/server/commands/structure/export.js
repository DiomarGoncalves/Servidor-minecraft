import{assertCuboidSelection as S}from"server/modules/assert.js";import{PlayerUtil as w}from"server/modules/player_util.js";import{RawText as _,regionSize as z,Server as x,Vector as F}from"library/Minecraft.js";import{StructureSaveMode as C,world as s}from"@minecraft/server";import{registerCommand as O}from"../register_commands.js";import{Jobs as k}from"server/modules/jobs.js";import{RegionBuffer as B}from"server/modules/region_buffer.js";const P={name:"export",permission:"worldedit.structure.export",description:"commands.wedit:export.description",usage:[{flag:"e"},{flag:"a"},{name:"name",type:"string"}]};function y(e,t,i){e.includes(":")||(e="mystructure:"+e);const n=i.dimension;let r=w.getBlockLocation(i);for(;n.getEntitiesAtBlockLocation(r).length;)r=r.offset(0,1,0);const d=n.spawnEntity("wedit:struct_meta",r);d.nameTag=t,s.structureManager.delete(e);const l=s.structureManager.createFromWorld(e,n,r,r,{includeBlocks:!1,includeEntities:!0,saveMode:C.World});return d.remove(),l}const v=[];O(P,function*(e,t,i){S(e);const n=e.selection.getRange(),r=t.dimension,d=i.has("a"),l=i.has("e");let o=i.get("name");o.includes(":")||(o="wedit:"+o);const[g,u]=o.split(":");yield*k.run(e,1,function*(){try{if(s.scoreboard.getObjective("wedit:exports")??s.scoreboard.addObjective("wedit:exports",""),x.runCommand(`scoreboard players set ${o} wedit:exports 1`).error)throw"Failed to save name to exports list";const m={saveAs:g+":weditstructexport_"+u,includeEntities:l};if(d&&(m.modifier=M=>!M.isAir),!(yield*B.createFromWorld(...n,r,m)))throw"Failed to save structure";const a=z(...n),c=w.getBlockLocation(t).add(.5),f=F.sub(n[0],c),h={size:{x:a.x,y:a.y,z:a.z},relative:{x:f.x,y:f.y,z:f.z},exporter:t.name};if(!y(g+":weditstructmeta_"+u,JSON.stringify(h),t))throw"Failed to save metadata";if(!y("weditstructref_"+u,o,t))throw"Failed to save reference data"}catch(m){const[a,c]=o.split(":");throw s.structureManager.delete(a+":weditstructexport_"+c),s.structureManager.delete(a+":weditstructmeta_"+c),s.structureManager.delete("weditstructref_"+c),x.runCommand(`scoreboard players reset ${o} wedit:exports`),console.error(m),"commands.generic.wedit:commandFail"}});let p=_.translate("commands.wedit:export.explain").with(i.get("name"));return v.includes(t)||(p=p.append("text",`
`).append("translate","commands.wedit:export.otherWorlds"),v.push(t)),p});
