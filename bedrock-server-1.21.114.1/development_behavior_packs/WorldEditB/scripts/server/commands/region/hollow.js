import{assertSelection as C}from"server/modules/assert.js";import{Jobs as n}from"server/modules/jobs.js";import{Pattern as V}from"server/modules/pattern.js";import{Server as F,RawText as G,Vector as I,iterateChunk as p,regionVolume as J}from"library/Minecraft.js";import{getWorldHeightLimits as M,locToString as b,stringToLoc as k}from"server/util.js";import{registerCommand as R}from"../register_commands.js";const T={name:"hollow",permission:"worldedit.region.hollow",description:"commands.wedit:hollow.description",usage:[{name:"thickness",type:"int",range:[1,null],default:1},{name:"pattern",type:"Pattern",default:new V("air")}]};function*v(t,d,m){const[i,c]=t.selection.getRange(),f=t.player.dimension,[w,S]=M(f),P=t.globalMask.withContext(t);i.y=Math.max(w,i.y),c.y=Math.min(S,c.y);const x=c.y>=i.y;d=d.withContext(t,[i,c]);const u=t.history,h=u.record();try{let g=0,o=0,a=J(i,c);if(x){yield n.nextStep("Calculating shape...");const l=new Set;for(const r of t.selection.getBlocks())p()&&(yield n.setProgress(o/a)),l.add(b(r)),o++;o=0,a=l.size,yield n.nextStep("Calculating blocks...");for(const r of t.selection.getBlocks({hollow:!0})){if(r.y<i.y||r.y>c.y)continue;const s=[r];for(;s.length!=0;){const e=s.shift(),y=b(e);if(yield n.setProgress(o/a),o++,!!l.has(y)&&F.block.isAirOrFluid((f.getBlock(e)??(yield*n.loadBlock(e))).permutation)){l.delete(y);for(const B of[[0,1,0],[0,-1,0],[1,0,0],[-1,0,0],[0,0,1],[0,0,-1]])s.push(I.add(e,B))}}}for(let r=1;r<=m;r++){const s=[];t:for(const e of l){yield n.setProgress(o/a),o+=.5/m;for(const y of[[0,1,0],[0,-1,0],[1,0,0],[-1,0,0],[0,0,1],[0,0,-1]])if(!l.has(b(k(e).add(y)))){s.push(e);continue t}}for(const e of s)p()&&(yield n.setProgress(o/a)),o+=.5/m,l.delete(e)}o=0,a=l.size,yield n.nextStep("Generating blocks..."),yield*u.trackRegion(h,i,c);for(const r of l){const s=k(r),e=f.getBlock(s)??(yield*n.loadBlock(s));P.matchesBlock(e)&&d.setBlock(e)&&g++,p()&&(yield n.setProgress(o/a)),o++}}return yield*u.commit(h),g}catch(g){throw u.cancel(h),g}}R(T,function*(t,d,m){C(t);const i=m.get("pattern"),c=m.get("thickness"),f=yield*n.run(t,3,v(t,i,c));return G.translate("commands.blocks.wedit:changed").with(`${f}`)});
