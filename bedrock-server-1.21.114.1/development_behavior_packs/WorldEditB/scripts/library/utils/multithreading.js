import{configuration as u}from"../configurations.js";import{system as d}from"@minecraft/server";import{contentLog as f}from"./contentlog.js";import{setTickTimeout as m,sleep as v}from"./scheduling.js";let w=1;const i=[],n=new Map,h={waitingForPromise:!0};class s{constructor(t){this.err=t}}class g{constructor(){this.active=!1;this.valid=!0;this.id=++w}start(t,...e){this.valid&&(this.task=t(...e),i.unshift(this),this.active=!0,this.valid=!1,u.multiThreadingEnabled||this.join())}async join(){if(this.valid||!this.active)return;for(i.includes(this)&&i.splice(i.indexOf(this),1),this.active=!1;Object.is(n.get(this),h);)await v(1);let t=n.get(this);n.delete(this);let e=t instanceof s?this.task.throw(t.err):this.task.next(t);for(;!e.done;){if(e.value instanceof Promise)try{t=await e.value}catch(r){t=new s(r)}e=t instanceof s?this.task.throw(t.err):this.task.next(t),t=void 0}}abort(){this.valid||!this.active||(i.includes(this)&&i.splice(i.indexOf(this),1),n.delete(this),this.active=!1)}getTask(){return this.task}isActive(){return this.active}toString(){return`[thread #${this.id}]`}}let c;d.runInterval(()=>{const a=Date.now();for(;Date.now()-a<u.multiThreadingTimeBudget&&i.length;){const t=i.pop();c=t;try{const e=n.get(t);if(Object.is(e,h)){m(()=>i.unshift(t));continue}n.delete(t);const r=e instanceof s?t.getTask().throw(e.err):t.getTask().next(e);if(r.done){t.join();continue}else r.value instanceof Promise&&(n.set(t,h),r.value.then(o=>n.set(t,o)).catch(o=>n.set(t,new s(o))));i.unshift(t)}catch(e){f.error(e),t.getTask().throw(e),t.join()}c=void 0}});let l=0;function p(){return l++>16?(l=0,!0):!1}function T(){return c}function k(){i.length=0}export{g as Thread,T as getCurrentThread,p as iterateChunk,k as shutdownThreads};
