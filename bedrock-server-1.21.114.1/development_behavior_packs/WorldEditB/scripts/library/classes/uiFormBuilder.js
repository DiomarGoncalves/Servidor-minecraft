import{MessageFormData as l,ActionFormData as h,ModalFormData as f,FormCancelationReason as T}from"@minecraft/server-ui";import{setTickTimeout as p,contentLog as g}from"library/Minecraft.js";class u{constructor(e){this.form=e,this.cancelAction=e.cancel}exit(e,t){}handleCancel(e,t,o){return e.canceled?(e.cancelationReason==T.UserBusy?p(()=>this.enter(t,o)):(o.goto(void 0),this.cancelAction?.(o,t)),!0):!1}buildFormData(e,t,o){const s=i=>this.resolve(i,e,t);return typeof o=="string"?o={rawtext:[{text:"\xA7c"},{translate:o},{text:"\xA7r"}]}:o&&(o={rawtext:[{text:"\xA7c"},...o.rawtext,{text:"\xA7r"}]}),this.build(this.form,s,o)}resolve(e,t,o){return e instanceof Function?e(o,t):e}}class d extends u{constructor(e){super(e),this.action1=e.button2.action,this.action2=e.button1.action}build(e,t){const o=new l;return o.title(t(e.title)),o.body(t(e.message)),o.button1(t(e.button2.text)),o.button2(t(e.button1.text)),o}enter(e,t){this.buildFormData(e,t).show(e).then(o=>{this.handleCancel(o,e,t)||(t.goto(void 0),o.selection==0?this.action1(t,e):o.selection==1&&this.action2(t,e))})}}class F extends u{constructor(){super(...arguments);this.actions=[]}build(t,o,s){this.actions=[];const i=new h;i.title(s??o(t.title)),t.message&&i.body(o(t.message)),o(a=>a.canGoBack())&&(i.button("<< Back"),this.actions.push(a=>a.back()));for(const a of o(t.buttons))i.button(o(a.text),o(a.icon)),this.actions.push(a.action);return i}enter(t,o,s){const i=this.buildFormData(t,o,s),a=this.actions;i.show(t).then(r=>{this.handleCancel(r,t,o)||(o.goto(void 0),a[r.selection]?.(o,t))})}}class b extends u{constructor(t){super(t);this.inputNames=[];this.submit=t.submit}build(t,o,s){this.inputNames=[];const i=new f;i.title(s??o(t.title));const a=o(t.inputs);for(const r in a){const n=a[r];n.type=="dropdown"?i.dropdown(o(n.name),o(n.options),{defaultValueIndex:o(n.default)}):n.type=="slider"?i.slider(o(n.name),o(n.min),o(n.max),{valueStep:o(n.step??1),defaultValue:o(n.default)}):n.type=="textField"?i.textField(o(n.name),o(n.placeholder),{defaultValue:o(n.default)}):n.type=="toggle"&&i.toggle(o(n.name),{defaultValue:o(n.default)}),this.inputNames.push(r)}return i}enter(t,o,s){const i=this.buildFormData(t,o,s),a=this.inputNames;i.show(t).then(r=>{if(this.handleCancel(r,t,o))return;const n={};for(const m in r.formValues)n[a[m]]=r.formValues[m];o.goto(void 0),this.submit(o,t,n)})}}class x{constructor(e){this.player=e;this.stack=[];this.data={}}getData(e){return this.data[e]}setData(e,t){this.data[e]=t}goto(e){if(e&&this.stack[this.stack.length-1]==="$___confirmMenu___")throw Error("Can't go to another form from a confirmation menu!");this._goto(e)}back(){this.stack.pop(),this._goto(this.stack.pop())}returnto(e){let t;for(;t=this.stack.pop();)if(t===e){this._goto(e);return}this._goto(void 0)}confirm(e,t,o,s){this.stack.push("$___confirmMenu___"),new d({title:e,message:t,button1:{text:"No",action:s??(a=>a.back())},button2:{text:"Yes",action:o}}).enter(this.player,this)}error(e){this._goto(this.stack[this.stack.length-1],e)}canGoBack(){return this.stack.length>1}get currentMenu(){return this.stack[this.stack.length-1]}_goto(e,t){if(e&&e!==this.stack[this.stack.length-1]&&this.stack.push(e),this.stack.length>=64)throw Error("UI Stack overflow!");y.goto(e,this.player,this,t)}}class M{constructor(){this.forms=new Map;this.active=new Map}register(e,t){if(this.forms.has(e))throw`UIForm by the name ${e} has already been registered.`;"button1"in t?this.forms.set(e,new d(t)):"buttons"in t?this.forms.set(e,new F(t)):"inputs"in t&&this.forms.set(e,new b(t))}show(e,t,o){if(this.displayingUI(t))return!0;const s=new x(t);return Object.entries(o??{}).forEach(i=>s.setData(i[0],i[1])),s.goto(e),!1}goto(e,t,o,s){if(this.active.has(t)&&(this.active.get(t).exit(t,o),this.active.delete(t)),e)if(this.forms.has(e)){g.debug("UI going to",e,"for",t.name);const i=this.forms.get(e);return this.active.set(t,i),i.enter(t,o,s),i}else throw new TypeError(`Menu "${e}" has not been registered!`);else return}displayingUI(e,t){if(!this.active.has(e))return!1;if(!t)return!0;const o=this.active.get(e);for(const s of this.forms.values())if(s==o)return!0;return!1}}const y=new M;export{y as UIForms};
