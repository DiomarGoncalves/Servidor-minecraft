import{world as g}from"@minecraft/server";import{print as l}from"server/util.js";import p from"whitelist.js";import y from"config.js";import{contentLog as o,Server as n,configuration as h}from"library/Minecraft.js";import{getSession as s,removeSession as b}from"server/sessions.js";import{PlayerUtil as a}from"server/modules/player_util.js";import"server/commands/command_list.js";import"server/tools/tool_list.js";import"server/ui/index.js";n.setMaxListeners(256),h.multiThreadingTimeBudget=y.asyncTimeBudget;const i=[];let d=!1;n.on("ready",e=>{o.debug(`World has been loaded in ${e.loadTime} ticks!`),d=!0}),n.on("playerLoaded",e=>{o.debug(`player ${e.player.name} loaded.`),d&&f(e.player)}),n.on("playerLeave",e=>{o.debug(`player ${e.playerName} left.`),m(e.playerId)}),n.on("tick",()=>{if(!d)return;const e=g.getPlayers().filter(r=>r!=null);for(const r of e)if(!i.includes(r)&&(a.isHotbarStashed(r)&&a.restoreHotbar(r),f(r))){l("worldedit.permission.granted",r);continue}for(let r=i.length-1;r>=0;r--){try{const c=i[r].name}catch{o.debug("A builder no longer exists!"),i.splice(r,1);continue}const t=i[r];u(t)?s(t):(m(t.id),o.log(`${t.name} has been revoked of their worldedit permissions.`),l("worldedit.permission.revoked",t))}});function f(e){return u(e)&&!i.includes(e)?(s(e),i.push(e),o.log(`${e.name} has been given worldedit permissions.`),!0):!1}function m(e){let r=-1;do r=i.findIndex(t=>{try{return t.id==e}catch{return!0}}),r!=-1&&i.splice(r,1);while(r!=-1);b(e),o.debug("Removed player from world edit!")}function u(e){if(!p())return!0;for(const r of e.getTags())if(r.startsWith("worldedit"))return!0;return!1}
